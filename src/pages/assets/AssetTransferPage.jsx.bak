// src/pages/AssetTransferPage.jsx
import React, { useEffect, useMemo, useRef, useState, useCallback, } from "react";
import { Box, Typography, Button, Card, CardContent, Grid, Select, MenuItem, FormControl, InputLabel, Paper, Tabs, Tab, Chip, Dialog, DialogActions, DialogContent, DialogTitle, Checkbox, ListItemText, OutlinedInput, IconButton, TextField, DialogContentText, Toolbar, TableContainer, Table, TableHead, TableRow, TableCell, TableBody, Stack, Divider, Tooltip, Snackbar, Alert, Avatar, Skeleton, Drawer, Badge, ToggleButton, ToggleButtonGroup, Stepper, Step, StepLabel, Autocomplete, CardActions, Collapse, CardActionArea, useTheme, useMediaQuery, FormControlLabel, } from "@mui/material";
import { alpha } from "@mui/material/styles";
import {
    SwapHoriz as ArrowRightLeft,
    Check,
    Edit as FilePen,
    Handshake,
    Send,
    HowToReg as UserCheck,
    Warehouse,
    AddCircle as PlusCircle,
    Edit,
    Delete as Trash2,
    Close as X,
    FilterList as Filter,
    Visibility as Eye,
    TableChart as TableProperties,
    AccessTime as Clock,
    Inbox,
    History,
    NoteAdd as FilePlus,
    SpeakerNotesOff as FileX,
    Group as Users,
    Description as Sheet,
    Print as Printer,
    FactCheck as BookCheck,
    ChevronRight,
    QrCode,
    ArrowForward as ArrowRight,
    CalendarToday as Calendar,
    Inventory2,
    LocalOffer as TagIcon,
    Business,
    Add,
} from "@mui/icons-material";
import { motion } from "framer-motion";
import { db, functions } from "../../services/firebase-config";
import { httpsCallable } from "firebase/functions";
import { doc, updateDoc, deleteDoc, writeBatch, serverTimestamp, onSnapshot, runTransaction, increment, } from "firebase/firestore";
import { useAssetManagement } from "../../hooks/useAssetManagement";
import { useReactToPrint } from "react-to-print";
import { QRCodeSVG } from "qrcode.react";

import { TransferPrintTemplate } from '../../components/print-templates/TransferPrintTemplate'
import { AssetListPrintTemplate } from "../../components/print-templates/AssetListPrintTemplate";
import { AssetSummaryPrintTemplate } from "../../components/print-templates/AssetSummaryPrintTemplate";
import { RequestPrintTemplate } from "../../components/print-templates/RequestPrintTemplate";
import { CheckCircleOutline, GroupWork } from "@mui/icons-material";
import { ALL_STATUS, reportStatusConfig, reportWorkflows, requestStatusConfig, statusConfig } from "../../utils/constants.jsx";
import { AssetLabelPrintTemplate } from "../../components/print-templates/AssetLabelPrintTemplate";
import { EmptyState, ErrorState } from "../../components/common";
import { LocalizationProvider, DatePicker } from '@mui/x-date-pickers';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { assetSchema } from "../../schemas/assetSchema";
import { vi } from 'date-fns/locale'; // Import tiáº¿ng Viá»‡t cho lá»‹ch

import { shortId, normVn, toDateObj, formatTime, fullTime, formatDate, checkDuplicate, hi } from "../../utils/assetUtils";
import SignatureTimeline from "../../components/timeline/SignatureTimeline";
import RequestSignatureTimeline from "../../components/timeline/RequestSignatureTimeline";
import ReportSignatureTimeline from "../../components/timeline/ReportSignatureTimeline";
import WorkflowCard from "../../components/cards/WorkflowCard";
import RequestCardSkeleton from "../../components/cards/RequestCardSkeleton";
import AssetCardMobile from "../../components/assets/AssetCardMobile";
import AssetTableRow from "../../components/assets/AssetTableRow";
import TransferTableRowMobile from "../../components/assets/TransferTableRowMobile";
import RequestTableRowMobile from "../../components/assets/RequestTableRowMobile";
import ReportTableRowMobile from "../../components/assets/ReportTableRowMobile";
import { StatCardSkeleton, TransferSkeleton, AssetCardSkeleton } from "../../components/assets/AssetSkeletons";
import DashboardTab from "../../components/tabs/DashboardTab";


const getApprovalActionLabel = (req) => {
    if (!req) return "Duyá»‡t";
    switch (req.status) {
        case "PENDING_HC":
            return "Duyá»‡t P.HC";
        case "PENDING_BLOCK_LEADER":
            return `Duyá»‡t Khá»‘i ${req.managementBlock || ''}`;
        case "PENDING_KT":
            return "Duyá»‡t P.KT & HoĂ n táº¥t";
        default:
            return "Duyá»‡t";
    }
};

export default function AssetTransferPage() {

    // âœ… REFACTORED: Sá»­ dá»¥ng useAssetManagement hook thay vĂ¬ duplicate code
    const {
        currentUser,
        departments,
        assets,
        transfers,
        setTransfers, // Cáº§n giá»¯ láº¡i Ä‘á»ƒ optimistic update
        assetRequests,
        inventoryReports,
        loading,
        error,
        setError,
        blockLeaders,
        approvalPermissions,
        assetManagerEmails,
        permissions: {
            canManageAssets,
            canSignSender,
            canSignReceiver,
            canSignAdmin,
            canDeleteTransfer,
            canProcessRequest,
            canProcessReport,
            canDeleteReport
        }
    } = useAssetManagement();

    // UI States (khĂ´ng duplicate vá»›i hook)
    const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
    const [printType, setPrintType] = useState('department');
    const [selectedDeptForPrint, setSelectedDeptForPrint] = useState('');
    const [deleteReportConfirm, setDeleteReportConfirm] = useState(null);

    const [rejectConfirm, setRejectConfirm] = useState(null); // LÆ°u request cáº§n tá»« chá»‘i
    const [deleteRequestConfirm, setDeleteRequestConfirm] = useState(null);
    const [expandedRequestId, setExpandedRequestId] = useState(null);
    const [creating, setCreating] = useState(false);
    const [isCreatingReport, setIsCreatingReport] = useState(false);

    const [createNonce, setCreateNonce] = useState("");
    // States for UI controls
    const [drawerOpen, setDrawerOpen] = useState(false);
    const [search, setSearch] = useState("");
    const [statusMulti, setStatusMulti] = useState([]);
    const [fromDeptIds, setFromDeptIds] = useState([]);
    const [toDeptIds, setToDeptIds] = useState([]);
    const [createdBy, setCreatedBy] = useState("");
    const searchDeb = useRef(null);
    const [debSearch, setDebSearch] = useState("");
    const [createdByDeb, setCreatedByDeb] = useState("");
    const [tabIndex, setTabIndex] = useState(0);

    // Asset Tab states
    const [assetSearch, setAssetSearch] = useState("");
    const [filterDeptsForAsset, setFilterDeptsForAsset] = useState([]); // <-- THAY Äá»”I á» ÄĂ‚Y
    const [visibleAssetCount, setVisibleAssetCount] = useState(100); // Hiá»ƒn thá»‹ 100 tĂ i sáº£n Ä‘áº§u tiĂªn
    const [isAssetModalOpen, setIsAssetModalOpen] = useState(false);
    const [modalMode, setModalMode] = useState("add"); // "add" | "edit"

    // React Hook Form setup
    const { register, handleSubmit, reset, control, formState: { errors }, setValue } = useForm({
        resolver: zodResolver(assetSchema),
        defaultValues: {
            name: "",
            size: "",
            description: "",
            quantity: 1,
            unit: "",
            notes: "",
            departmentId: "",
        }
    });

    // const [currentAsset, setCurrentAsset] = useState({}); // REMOVED: Replaced by RHF
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [reduceQuantityTarget, setReduceQuantityTarget] = useState(null); // LÆ°u tĂ i sáº£n Ä‘ang Ä‘Æ°á»£c thao tĂ¡c
    const [quantityToDelete, setQuantityToDelete] = useState(1); // LÆ°u sá»‘ lÆ°á»£ng muá»‘n xĂ³a trong dialog
    const [isPasteModalOpen, setIsPasteModalOpen] = useState(false);
    const [pastedText, setPastedText] = useState("");

    // Transfer modal states
    const [isTransferModalOpen, setIsTransferModalOpen] = useState(false);
    const [createStep, setCreateStep] = useState(0);
    const [fromDept, setFromDept] = useState("");
    const [toDept, setToDept] = useState("");
    const [selectedAssets, setSelectedAssets] = useState([]);
    const [selectedQuantities, setSelectedQuantities] = useState({});
    const [assetSearchInDialog, setAssetSearchInDialog] = useState("");

    // Detail view
    const [detailViewOpen, setDetailViewOpen] = useState(false);
    const [selectedTransfer, setSelectedTransfer] = useState(null);

    // NEW: State cho dialog chi tiáº¿t YĂU Cáº¦U
    const [isRequestDetailOpen, setIsRequestDetailOpen] = useState(false);
    const [selectedRequest, setSelectedRequest] = useState(null);

    // Feedback states
    const [toast, setToast] = useState({ open: false, msg: "", severity: "success", });
    const [undo, setUndo] = useState({ open: false, transfer: null });
    const [signing, setSigning] = useState({});
    const [isProcessingRequest, setIsProcessingRequest] = useState({}); // NEW: State loading khi duyá»‡t
    // >>> THĂM CĂC STATE NĂ€Y VĂ€O ÄĂ‚Y <<<
    const [processingReport, setProcessingReport] = useState({});
    const [isReportDetailOpen, setIsReportDetailOpen] = useState(false);
    const [selectedReport, setSelectedReport] = useState(null);
    const [rejectReportConfirm, setRejectReportConfirm] = useState(null);
    const [confirmation, setConfirmation] = useState(null); // Äá»ƒ xĂ¡c nháº­n cáº­p nháº­t sá»‘ lÆ°á»£ng
    // blockLeaders vĂ  approvalPermissions Ä‘Ă£ Ä‘Æ°á»£c láº¥y tá»« useAssetManagement hook

    // 1. Khai bĂ¡o state Ä‘á»ƒ lÆ°u thĂ´ng tin cĂ´ng ty
    const [companyInfo, setCompanyInfo] = useState(null);
    const [selectedBlockForPrint, setSelectedBlockForPrint] = useState('');

    // âœ… BÆ¯á»C 2: ThĂªm cĂ¡c state vĂ  ref má»›i cho chá»©c nÄƒng in tem
    const [isLabelPrintModalOpen, setIsLabelPrintModalOpen] = useState(false);

    {/* âœ… THAY Äá»”I: Sá»­ dá»¥ng lazy initializer cá»§a useState Ä‘á»ƒ Ä‘á»c tá»« sessionStorage */ }
    const [selectedAssetIdsForPrint, setSelectedAssetIdsForPrint] = useState(() => {
        try {
            // Láº¥y dá»¯ liá»‡u Ä‘Ă£ lÆ°u tá»« session
            const savedSelection = sessionStorage.getItem('selectedAssetIdsForPrint');
            // Náº¿u cĂ³, parse nĂ³; náº¿u khĂ´ng, tráº£ vá» máº£ng rá»—ng
            return savedSelection ? JSON.parse(savedSelection) : [];
        } catch (error) {
            console.error("Lá»—i khi Ä‘á»c sessionStorage:", error);
            return []; // Tráº£ vá» rá»—ng náº¿u cĂ³ lá»—i
        }
    }); const labelPrintRef = useRef(null);
    // âœ… BÆ¯á»C 3: THĂM CĂC STATE NĂ€Y
    const [isUpdateDateModalOpen, setIsUpdateDateModalOpen] = useState(false);
    const [newCheckDate, setNewCheckDate] = useState(null); // LÆ°u ngĂ y má»›i Ä‘Æ°á»£c chá»n
    const [isUpdatingDates, setIsUpdatingDates] = useState(false); // Tráº¡ng thĂ¡i loading
    // src/pages/AssetTransferPage.jsx

    const handlePrintLabels = useReactToPrint({
        // Sá»­a tá»« 'contentRef' thĂ nh 'content' vĂ  dĂ¹ng hĂ m mÅ©i tĂªn
        contentRef: labelPrintRef,
        documentTitle: `tem-tai-san-${new Date().toISOString()}`,
    });
    // âœ… Vá» TRĂ Tá»T NHáº¤T Äá»‚ Äáº¶T ÄOáº N CODE NĂ€Y LĂ€ á» ÄĂ‚Y
    const managementBlocks = useMemo(() => {
        if (!departments) return [];
        const blocks = new Set(departments.map(d => d.managementBlock).filter(Boolean));
        return Array.from(blocks).sort((a, b) => a.localeCompare(b, 'vi')); // Sáº¯p xáº¿p theo tiáº¿ng Viá»‡t
    }, [departments]);
    // 2. useEffect Ä‘á»ƒ láº¥y thĂ´ng tin cĂ´ng ty (báº¡n cĂ³ thá»ƒ thay báº±ng logic gá»i Firestore tháº­t)
    useEffect(() => {
        const fetchCompanyInfo = async () => {
            // Táº¡m thá»i hardcode, báº¡n nĂªn láº¥y tá»« Firestore
            setCompanyInfo({
                name: 'CĂ”NG TY CP XĂ‚Y Dá»°NG BĂCH KHOA',
                address: 'Sá»‘ 39, ÄÆ°á»ng Tráº§n HÆ°ng Äáº¡o, PhÆ°á»ng Long XuyĂªn, Tá»‰nh An Giang',
                phone: '02963 835 787'
            });
        };
        fetchCompanyInfo();
    }, []);

    // 3. Khai bĂ¡o ref vĂ  hĂ m in cho bĂ¡o cĂ¡o
    const reportPrintRef = useRef(null);
    const handlePrintReport = useReactToPrint({
        contentRef: reportPrintRef,  // âœ… v3
        documentTitle: `bien-ban-kiem-ke-${selectedReport?.departmentName?.replace(/\s+/g, '_') || 'tong-hop'}-${selectedReport?.id?.slice(0, 6) || ''}`,
    });
    const printRef = useRef(null);
    const handlePrint = useReactToPrint({
        contentRef: printRef,        // âœ… v3
        documentTitle: `phieu-luan-chuyen-${selectedTransfer?.id?.slice(0, 6) || ''}`,
        onAfterPrint: () => console.log('Printed successfully!'),
    });
    // âœ… THĂM KHAI BĂO NĂ€Y VĂ€O
    const requestPrintRef = useRef(null);
    const handlePrintRequest = useReactToPrint({
        contentRef: requestPrintRef,
        documentTitle: `phieu-yeu-cau-${selectedRequest?.maPhieuHienThi || ''}`,
        onAfterPrint: () => console.log('Printed successfully!'),

    });

    // --- TĂ¬m kiáº¿m & cháº¿ Ä‘á»™ xem cho tab BĂ¡o cĂ¡o ---
    const [reportSearch, setReportSearch] = useState("");

    // âœ… BÆ¯á»C 1: ThĂªm hook Ä‘á»ƒ phĂ¡t hiá»‡n mĂ n hĂ¬nh mobile
    const theme = useTheme();
    const isMobile = useMediaQuery(theme.breakpoints.down('sm'));


    // âœ… REFACTORED: Auth listener, canManageAssets, vĂ  Data listeners 
    // Ä‘Ă£ Ä‘Æ°á»£c chuyá»ƒn sang useAssetManagement hook

    // âœ… Cáº£i thiá»‡n: ThĂªm keyboard shortcuts
    useEffect(() => {
        const handleKeyDown = (e) => {
            // Ctrl/Cmd + K: Má»Ÿ search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                // Focus vĂ o search field cá»§a tab hiá»‡n táº¡i
                const searchInput = document.querySelector('input[placeholder*="TĂ¬m"]');
                if (searchInput) searchInput.focus();
            }
            // Escape: ÄĂ³ng drawer/dialog
            if (e.key === 'Escape') {
                if (drawerOpen) {
                    setDrawerOpen(false);
                }
            }
            // Ctrl/Cmd + N: Táº¡o má»›i (tĂ¹y theo tab)
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (tabIndex === 1) handleOpenTransferModal();
                else if (tabIndex === 2 && canManageAssets) handleOpenAddModal();
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [drawerOpen, tabIndex, canManageAssets]);
    {/* âœ… THĂM Má»I: useEffect nĂ y Ä‘á»ƒ lÆ°u lá»±a chá»n tĂ i sáº£n vĂ o sessionStorage */ }
    useEffect(() => {
        try {
            // LÆ°u state hiá»‡n táº¡i vĂ o session má»—i khi nĂ³ thay Ä‘á»•i
            sessionStorage.setItem('selectedAssetIdsForPrint', JSON.stringify(selectedAssetIdsForPrint));
        } catch (error) {
            console.error("Lá»—i khi ghi sessionStorage:", error);
        }
    }, [selectedAssetIdsForPrint]); // <-- Dependency: Cháº¡y láº¡i khi state nĂ y thay Ä‘á»•i

    // Debounce search inputs
    useEffect(() => { clearTimeout(searchDeb.current); searchDeb.current = setTimeout(() => setDebSearch(search), 300); return () => clearTimeout(searchDeb.current) }, [search]);
    useEffect(() => { const id = setTimeout(() => setCreatedByDeb(createdBy), 300); return () => clearTimeout(id) }, [createdBy]);

    // Permission helpers for Transfers
    // HĂ m nĂ y kiá»ƒm tra ngÆ°á»i dĂ¹ng cĂ³ pháº£i lĂ£nh Ä‘áº¡o cá»§a phĂ²ng ban khĂ´ng
    // MĂƒ Má»I CHO canSignSender

    // âœ… REFACTORED: Permission helpers (canSignSender, canSignReceiver, canSignAdmin, 
    // canDeleteTransfer, canProcessRequest, canProcessReport, canDeleteReport) 
    // Ä‘Ă£ Ä‘Æ°á»£c chuyá»ƒn sang useAssetManagement hook vĂ  destructure á»Ÿ trĂªn

    // isMyTurn sá»­ dá»¥ng cĂ¡c permission tá»« hook
    const isMyTurn = useCallback((t) => {
        if (!currentUser) return false;
        if (currentUser?.role === "admin") { return t.status !== "COMPLETED" }
        return (
            (t.status === "PENDING_SENDER" && canSignSender(t)) ||
            (t.status === "PENDING_RECEIVER" && canSignReceiver(t)) ||
            (t.status === "PENDING_ADMIN" && canSignAdmin(t))
        )
    }, [currentUser, canSignSender, canSignReceiver, canSignAdmin]);
    // Derived data
    const assetsWithDept = useMemo(() => { const byId = new Map(departments.map((d) => [d.id, d.name])); return assets.map((a) => ({ ...a, departmentName: byId.get(a.departmentId) || "ChÆ°a gĂ¡n" })) }, [assets, departments]);
    const assetsWithAvailability = useMemo(() => { return assetsWithDept.map((a) => ({ ...a, reserved: Number(a.reserved || 0), availableQuantity: Math.max(0, Number(a.quantity || 0) - Number(a.reserved || 0)) })) }, [assetsWithDept]);
    // âœ… BÆ¯á»C 4: Táº¡o má»™t useMemo Ä‘á»ƒ láº¥y thĂ´ng tin chi tiáº¿t cĂ¡c tĂ i sáº£n Ä‘Ă£ chá»n Ä‘á»ƒ in
    const assetsToPrint = useMemo(() => {
        if (selectedAssetIdsForPrint.length === 0) return [];

        const assetMap = new Map(assetsWithDept.map(a => [a.id, a]));
        const selectedAssets = selectedAssetIdsForPrint.map(id => assetMap.get(id)).filter(Boolean);

        // DĂ¹ng flatMap Ä‘á»ƒ "nhĂ¢n báº£n" cĂ¡c tĂ i sáº£n cĂ³ sá»‘ lÆ°á»£ng > 1
        return selectedAssets.flatMap(asset => {
            const quantity = Number(asset.quantity) || 0;
            if (quantity <= 0) return []; // Bá» qua náº¿u sá»‘ lÆ°á»£ng khĂ´ng há»£p lá»‡

            // Táº¡o ra má»™t máº£ng gá»“m 'quantity' báº£n sao cá»§a tĂ i sáº£n
            // Má»—i báº£n sao Ä‘Æ°á»£c bá»• sung thĂ´ng tin vá» sá»‘ thá»© tá»± Ä‘á»ƒ in
            return Array.from({ length: quantity }, (_, i) => ({
                ...asset,
                printIndex: i + 1,      // Sá»‘ thá»© tá»± cá»§a tem nĂ y (1, 2, 3,...)
                printTotal: quantity,   // Tá»•ng sá»‘ tem cho loáº¡i tĂ i sáº£n nĂ y
            }));
        });
    }, [selectedAssetIdsForPrint, assetsWithDept]);

    const filteredTransfers = useMemo(() => {
        let list = transfers;
        if (statusMulti.length > 0)
            list = list.filter((t) => statusMulti.includes(t.status));
        if (fromDeptIds.length > 0)
            list = list.filter((t) => fromDeptIds.includes(t.fromDeptId));
        if (toDeptIds.length > 0)
            list = list.filter((t) => toDeptIds.includes(t.toDeptId));
        if (createdByDeb.trim()) {
            const q = normVn(createdByDeb);
            list = list.filter((t) => normVn(t.createdBy?.name || "").includes(q));
        }
        if (debSearch.trim()) {
            const q = normVn(debSearch);

            list = list.filter((t) => {
                const from = normVn(t.from || "");
                const to = normVn(t.to || "");
                const id = normVn(t.id || "");
                const disp = normVn(t.maPhieuHienThi || "");

                const hitAsset = (t.assets || []).some((a) => normVn(a.name).includes(q));

                return (
                    id.includes(q) ||
                    disp.includes(q) ||
                    from.includes(q) ||
                    to.includes(q) ||
                    hitAsset
                );
            });
        }
        return list;
    }, [transfers, statusMulti, fromDeptIds, toDeptIds, createdByDeb, debSearch]);
    const filteredAssets = useMemo(() => {
        // áº¨n record quantity = 0 Ä‘á»ƒ khĂ´ng tháº¥y dĂ²ng â€œ0 CĂ¡iâ€
        let list = assetsWithDept.filter(a => Number(a.quantity || 0) > 0);

        // === Báº®T Äáº¦U THAY Äá»”I ===
        if (filterDeptsForAsset.length > 0) { // <-- Sá»­a Ä‘iá»u kiá»‡n
            list = list.filter((a) => filterDeptsForAsset.includes(a.departmentId)); // <-- Sá»­a logic lá»c
        }
        if (assetSearch.trim()) {
            const q = normVn(assetSearch);
            list = list.filter((a) => normVn(a.name).includes(q));
        }
        return list;
    }, [assetsWithDept, assetSearch, filterDeptsForAsset]);

    // âœ… FIX: Apply pagination using visibleAssetCount to limit rendered assets
    const paginatedAssets = useMemo(() => {
        return filteredAssets.slice(0, visibleAssetCount);
    }, [filteredAssets, visibleAssetCount]);
    // NhĂ³m theo phĂ²ng ban Ä‘á»ƒ render header má»—i nhĂ³m
    const groupedAssets = useMemo(() => {
        const map = new Map();
        for (const a of paginatedAssets) {
            const key = a.departmentId || 'unknown';
            const name = a.departmentName || 'ChÆ°a gĂ¡n';
            if (!map.has(key)) map.set(key, { name, items: [] });
            map.get(key).items.push(a);
        }
        // sort nhĂ³m & tá»«ng item cho Ä‘áº¹p
        const groups = [...map.values()]
            .sort((g1, g2) => g1.name.localeCompare(g2.name, 'vi'))
            .map(g => ({
                ...g,
                items: g.items.sort((x, y) => (x.name || '').localeCompare(y.name || '', 'vi'))
            }));
        return groups;
    }, [paginatedAssets]);

    const handleSelectAllAssets = (event) => {
        if (event.target.checked) {
            // Chá»n táº¥t cáº£ ID cá»§a tĂ i sáº£n Ä‘ang Ä‘Æ°á»£c lá»c
            const allAssetIds = filteredAssets.map((a) => a.id);
            setSelectedAssetIdsForPrint(allAssetIds);
            return;
        }
        // Bá» chá»n táº¥t cáº£
        setSelectedAssetIdsForPrint([]);
    };
    // âœ… BÆ¯á»C 6: ThĂªm hĂ m xá»­ lĂ½ chá»n/bá» chá»n má»™t tĂ i sáº£n
    const handleSelectAssetForPrint = useCallback((event, id) => {
        const selectedIndex = selectedAssetIdsForPrint.indexOf(id);
        let newSelected = [];

        if (selectedIndex === -1) {
            newSelected = newSelected.concat(selectedAssetIdsForPrint, id);
        } else if (selectedIndex === 0) {
            newSelected = newSelected.concat(selectedAssetIdsForPrint.slice(1));
        } else if (selectedIndex === selectedAssetIdsForPrint.length - 1) {
            newSelected = newSelected.concat(selectedAssetIdsForPrint.slice(0, -1));
        } else if (selectedIndex > 0) {
            newSelected = newSelected.concat(
                selectedAssetIdsForPrint.slice(0, selectedIndex),
                selectedAssetIdsForPrint.slice(selectedIndex + 1),
            );
        }
        setSelectedAssetIdsForPrint(newSelected);
    }, [selectedAssetIdsForPrint]);
    const handleMemoizedAssetEdit = useCallback((asset) => {
        if (canManageAssets) {
            handleOpenEditModal(asset);
        }
    }, [canManageAssets]); // handleOpenEditModal lĂ  hĂ m á»•n Ä‘á»‹nh
    const handleMemoizedAssetDelete = useCallback((asset) => {
        if (asset.quantity > 1) {
            setReduceQuantityTarget(asset);
            setQuantityToDelete(1);
        } else {
            setDeleteConfirm(asset);
        }
    }, []);
    // THAY THáº¾ useMemo CÅ¨ Báº°NG KHá»I NĂ€Y
    const requestsWithDeptName = useMemo(() => {
        // Táº¡o má»™t map Ä‘áº§y Ä‘á»§ thĂ´ng tin hÆ¡n
        const departmentMap = new Map(departments.map(d => [d.id, { name: d.name, managementBlock: d.managementBlock }]));

        return assetRequests.map(req => {
            const deptId = req.assetData?.departmentId || req.departmentId;
            const deptInfo = departmentMap.get(deptId);
            return {
                ...req,
                departmentName: deptInfo?.name || 'KhĂ´ng rĂµ',
                // âœ… Bá»• sung trÆ°á»ng managementBlock vĂ o tá»«ng request
                managementBlock: deptInfo?.managementBlock || null
            };
        });
    }, [assetRequests, departments]);
    const filteredRequests = useMemo(() => {
        const q = normVn(search);
        if (!q) return requestsWithDeptName;

        return requestsWithDeptName.filter((r) => {
            const id = normVn(r.id || "");
            const disp = normVn(r.maPhieuHienThi || "");
            const name = normVn(r.assetData?.name || "");
            const dept = normVn(r.departmentName || "");
            const rqer = normVn(r.requester?.name || "");

            return (
                id.includes(q) ||
                disp.includes(q) ||
                name.includes(q) ||
                dept.includes(q) ||
                rqer.includes(q)
            );
        });
    }, [requestsWithDeptName, search]);

    // Map kĂ¨m tĂªn phĂ²ng ban cho bĂ¡o cĂ¡o + filter theo search
    const reportsWithDeptName = useMemo(() => {
        const deptMap = new Map(departments.map(d => [d.id, d.name]));
        return (inventoryReports || []).map(r => {
            let name = "â€”"; // GiĂ¡ trá»‹ máº·c Ä‘á»‹nh

            // âœ… Bá»” SUNG LOGIC Má»I
            if (r.type === 'SUMMARY_REPORT') {
                name = "ToĂ n bá»™ cĂ´ng ty";
            } else if (r.blockName) { // Æ¯u tiĂªn hiá»ƒn thá»‹ tĂªn khá»‘i náº¿u cĂ³
                name = r.blockName
            } else if (r.departmentId) { // Sau Ä‘Ă³ má»›i tá»›i tĂªn phĂ²ng
                name = deptMap.get(r.departmentId) || "KhĂ´ng rĂµ";
            }

            return {
                ...r,
                departmentName: name,
            };
        });
    }, [inventoryReports, departments]);

    const filteredReports = useMemo(() => {
        const q = normVn(reportSearch || "");
        if (!q) return reportsWithDeptName;

        return reportsWithDeptName.filter((r) => {
            const id = normVn(r.id || "");
            const disp = normVn(r.maPhieuHienThi || "");
            const title = normVn(r.title || "");
            const dept = normVn(r.departmentName || "");
            const rqer = normVn(r.requester?.name || "");

            return (
                id.includes(q) ||
                disp.includes(q) ||
                title.includes(q) ||
                dept.includes(q) ||
                rqer.includes(q)
            );
        });
    }, [reportsWithDeptName, reportSearch]);
    // Thay tháº¿ toĂ n bá»™ khá»‘i useMemo 'groupedReportAssets' (tá»« dĂ²ng 1152) báº±ng mĂ£ sau:

    const groupedReportAssets = useMemo(() => {
        // Náº¿u khĂ´ng cĂ³ bĂ¡o cĂ¡o hoáº·c tĂ i sáº£n, tráº£ vá» máº£ng rá»—ng
        if (!selectedReport?.assets || !departments.length) return [];

        // âœ… Bá»” SUNG: Lá»c cĂ¡c tĂ i sáº£n cĂ³ quantity > 0 ngay tá»« Ä‘áº§u
        const filteredReportAssets = selectedReport.assets.filter(a => Number(a.quantity || 0) > 0);

        // Náº¿u khĂ´ng cĂ²n tĂ i sáº£n nĂ o sau khi lá»c
        if (filteredReportAssets.length === 0) return [];

        const departmentMap = new Map(departments.map(d => [d.id, { name: d.name, managementBlock: d.managementBlock }]));

        const groups = {};

        for (const asset of filteredReportAssets) { // Sá»­ dá»¥ng danh sĂ¡ch Ä‘Ă£ lá»c
            const deptInfo = departmentMap.get(asset.departmentId);
            const blockName = deptInfo?.managementBlock || "ChÆ°a phĂ¢n loáº¡i Khá»‘i";
            const deptName = deptInfo?.name || "ChÆ°a phĂ¢n loáº¡i PhĂ²ng";

            if (!groups[blockName]) {
                groups[blockName] = { blockName, departments: {} };
            }
            if (!groups[blockName].departments[deptName]) {
                groups[blockName].departments[deptName] = { deptName, assets: [] };
            }
            groups[blockName].departments[deptName].assets.push(asset);
        }

        // Chuyá»ƒn Ä‘á»•i object thĂ nh máº£ng vĂ  sáº¯p xáº¿p
        return Object.values(groups).sort((a, b) => a.blockName.localeCompare(b.blockName, 'vi')).map(block => ({
            ...block,
            departments: Object.values(block.departments).sort((a, b) => a.deptName.localeCompare(b.deptName, 'vi'))
        }));

    }, [selectedReport, departments]);

    // âœ… Báº N HĂƒY Äáº¶T KHá»I CODE Má»I VĂ€O NGAY ÄĂ‚Y
    const sortedDepartmentsForPrint = useMemo(() => {
        const blockOrder = [
            "HĂ nh chĂ­nh", "Cung á»©ng", "Tá»• Tháº§u", "Káº¿ toĂ¡n",
            "XNXD1", "XNXD2", "KH-ÄT", "NhĂ  mĂ¡y",
        ];

        return [...departments].sort((a, b) => {
            const blockA = a.managementBlock || "Î©";
            const blockB = b.managementBlock || "Î©";
            const indexA = blockOrder.indexOf(blockA);
            const indexB = blockOrder.indexOf(blockB);

            if (indexA !== -1 && indexB !== -1) {
                if (indexA !== indexB) {
                    return indexA - indexB;
                }
            }
            else if (indexA !== -1) return -1;
            else if (indexB !== -1) return 1;

            return a.name.localeCompare(b.name, 'vi');
        });
    }, [departments]);
    // âœ… Báº N HĂƒY Äáº¶T KHá»I CODE Má»I VĂ€O NGAY BĂN DÆ¯á»I ÄĂ‚Y
    const departmentAssetCounts = useMemo(() => {
        const counts = {};
        // Khá»Ÿi táº¡o táº¥t cáº£ phĂ²ng ban vá»›i 0 tĂ i sáº£n
        for (const dept of departments) {
            counts[dept.id] = 0;
        }
        // Äáº¿m sá»‘ tĂ i sáº£n trong má»—i phĂ²ng
        for (const asset of assets) {
            if (asset.departmentId && counts[asset.departmentId] !== undefined) {
                counts[asset.departmentId]++;
            }
        }
        return counts;
    }, [assets, departments]);
    // Stats

    const fromDeptOptionsForCreate = useMemo(() => { if (!currentUser) return []; if (currentUser?.role === "admin") return departments; const managed = new Set([...(currentUser.managedDepartmentIds || [])]); if (currentUser.primaryDepartmentId) { managed.add(currentUser.primaryDepartmentId) } return departments.filter((d) => managed.has(d.id)) }, [departments, currentUser]);

    // UI Handlers
    const handleOpenTransferModal = () => {
        setCreating(false);
        setCreateStep(0);
        setFromDept("");
        setToDept("");
        setSelectedAssets([]);
        setSelectedQuantities({});
        setAssetSearchInDialog("");
        setCreateNonce(crypto?.randomUUID?.() ?? `${Date.now()}_${Math.random()}`);
        setIsTransferModalOpen(!0)
    };

    // âœ… THĂM HĂ€M Má»I NĂ€Y VĂ€O
    const handleCloseTransferDrawer = () => {
        setIsTransferModalOpen(false);
        setAssetSearchInDialog("");
        // TĂ¹y chá»n: reset vá» bÆ°á»›c 0 khi Ä‘Ă³ng
        // setCreateStep(0); 
    };

    const handleOpenDetailView = (t) => { setSelectedTransfer(t); setDetailViewOpen(true) };
    const handleCloseDetailView = () => { setDetailViewOpen(false); setSelectedTransfer(null) };
    // NEW: HĂ m xá»­ lĂ½ cho dialog chi tiáº¿t YĂU Cáº¦U
    const requestDetailUnsubRef = useRef(null);

    // File: src/pages/AssetTransferPage.jsx

    const handleOpenRequestDetail = (req) => {
        // req á»Ÿ Ä‘Ă¢y lĂ  object Ä‘Ă£ cĂ³ sáºµn departmentName vĂ  managementBlock
        if (requestDetailUnsubRef.current) requestDetailUnsubRef.current();

        // sub realtime vĂ o doc Ä‘ang xem
        requestDetailUnsubRef.current = onSnapshot(
            doc(db, "asset_requests", req.id),
            (snap) => {
                if (snap.exists()) {
                    // âœ… Káº¾T Há»¢P Dá»® LIá»†U CĂ“ Sáº´N VĂ€ Dá»® LIá»†U Má»I NHáº¤T
                    setSelectedRequest({
                        ...req, // Báº¯t Ä‘áº§u vá»›i dá»¯ liá»‡u Ä‘Ă£ cĂ³ (gá»“m departmentName, managementBlock)
                        ...snap.data(), // Ghi Ä‘Ă¨ báº±ng dá»¯ liá»‡u má»›i nháº¥t tá»« server (status, signatures,...)
                        id: snap.id, // Äáº£m báº£o dĂ¹ng ID tá»« snapshot
                    });
                } else {
                    setSelectedRequest(null);
                }
            }
        );

        setIsRequestDetailOpen(true);
    };

    const handleCloseRequestDetail = () => {
        if (requestDetailUnsubRef.current) {
            requestDetailUnsubRef.current();
            requestDetailUnsubRef.current = null;
        }
        setSelectedRequest(null);
        setIsRequestDetailOpen(false);
    };

    const handleOpenAddModal = () => {
        setModalMode("add");
        // setCurrentAsset({}); // REMOVED
        reset({
            name: "",
            size: "",
            description: "",
            quantity: 1,
            unit: "",
            notes: "",
            departmentId: "",
        });
        setIsAssetModalOpen(true);
    };
    const handleOpenEditModal = (asset) => {
        setModalMode("edit");
        // setCurrentAsset(asset); // REMOVED
        reset({
            id: asset.id, // Keep ID for update
            name: asset.name,
            size: asset.size || "",
            description: asset.description || "",
            quantity: asset.quantity,
            unit: asset.unit,
            notes: asset.notes || "",
            departmentId: asset.departmentId,
        });
        setIsAssetModalOpen(true);
    };
    const handleSign = async (t, role) => {
        if (!currentUser || signing[t.id]) return;

        const canSender = canSignSender(t);
        const canReceiver = canSignReceiver(t);
        const canAdmin = canSignAdmin(t);

        const fromBlock = departments.find(d => d.id === t.fromDeptId)?.managementBlock;
        const toBlock = departments.find(d => d.id === t.toDeptId)?.managementBlock;
        const permKey = (fromBlock || toBlock) === 'NhĂ  mĂ¡y' ? 'NhĂ  mĂ¡y' : 'default';

        console.log('[handleSign] before check', {
            role, status: t.status, fromBlock, toBlock, permKey,
            _canSender: canSender, _canReceiver: canReceiver, _canAdmin: canAdmin
        });

        const nextMap = { sender: 'PENDING_RECEIVER', receiver: 'PENDING_ADMIN', admin: 'COMPLETED' };
        const canMap = { sender: canSender, receiver: canReceiver, admin: canAdmin };

        const nextStatus = nextMap[role] ?? t.status;
        const can = !!canMap[role];

        console.log('[handleSign] computed', { role, nextStatus, can });

        if (!can) {
            setToast({ open: true, msg: 'Báº¡n khĂ´ng cĂ³ quyá»n hoáº·c chÆ°a tá»›i lÆ°á»£t kĂ½.', severity: 'warning' });
            return;
        }

        setSigning(s => ({ ...s, [t.id]: true }));

        try {
            const ref = doc(db, 'transfers', t.id);
            let iWonToMoveStock = false;

            await runTransaction(db, async (tx) => {
                const snap = await tx.get(ref);
                if (!snap.exists()) throw new Error('Phiáº¿u khĂ´ng tá»“n táº¡i');
                const cur = snap.data();

                const ok =
                    (role === 'sender' && cur.status === 'PENDING_SENDER') ||
                    (role === 'receiver' && cur.status === 'PENDING_RECEIVER') ||
                    (role === 'admin' && cur.status === 'PENDING_ADMIN');

                if (!ok) throw new Error('Tráº¡ng thĂ¡i Ä‘Ă£ thay Ä‘á»•i hoáº·c báº¡n khĂ´ng Ä‘á»§ quyá»n');

                const signature = {
                    uid: currentUser.uid,
                    name: currentUser.displayName || currentUser.email || 'NgÆ°á»i kĂ½',
                    signedAt: serverTimestamp(),
                    signedAtLocal: new Date().toISOString(),
                };

                const updates = {
                    [`signatures.${role}`]: signature,
                    status: nextStatus,
                    version: increment(1),
                };

                if (nextStatus === 'COMPLETED') {
                    if (!cur.stockMoved) {
                        updates.stockMoved = true;
                        iWonToMoveStock = true;
                    }
                }

                tx.update(ref, updates);
            });

            // Sau khi chuyá»ƒn tráº¡ng thĂ¡i thĂ nh COMPLETED láº§n Ä‘áº§u: di chuyá»ƒn kho
            if (iWonToMoveStock) {
                try {
                    const batch = writeBatch(db);
                    const toId =
                        t.toDeptId || departments.find((d) => d.name === t.to)?.id || null;

                    // map hiá»‡n tráº¡ng assets Ä‘á»ƒ tra nhanh
                    const assetMap = new Map(assets.map((a) => [a.id, a]));
                    const key = (x) =>
                        [(x?.name || '').trim().toLowerCase(),
                        (x?.unit || '').trim().toLowerCase(),
                        (x?.size || '').trim().toLowerCase()].join('||');

                    for (const item of (t.assets || [])) {
                        const src = assetMap.get(item.id);
                        if (!src) continue;

                        const move = Number(item.quantity || 0);
                        const srcQty = Number(src.quantity || 0);

                        // Náº¿u chuyá»ƒn háº¿t => Ä‘á»•i departmentId luĂ´n
                        if (move >= srcQty) {
                            batch.update(doc(db, 'assets', src.id), { departmentId: toId });
                        } else {
                            // Chuyá»ƒn má»™t pháº§n => giáº£m táº¡i nguá»“n
                            batch.update(doc(db, 'assets', src.id), { quantity: srcQty - move });

                            // TÄƒng / táº¡o táº¡i Ä‘Ă­ch (khá»›p theo name+unit+size)
                            const existingDest = assets.find(
                                (a) => a.departmentId === toId && key(a) === key(src)
                            );

                            if (existingDest) {
                                batch.update(doc(db, 'assets', existingDest.id), {
                                    quantity: Number(existingDest.quantity || 0) + move,
                                });
                            } else {
                                batch.set(doc(collection(db, 'assets')), {
                                    name: src.name,
                                    size: src.size || '',
                                    description: src.description || '',
                                    unit: src.unit,
                                    quantity: move,
                                    notes: src.notes || '',
                                    departmentId: toId,
                                });
                            }
                        }

                        // Giáº£m reserved táº¡i nguá»“n
                        const curReserved = Number(src.reserved || 0);
                        const newReserved = Math.max(0, curReserved - move);
                        batch.update(doc(db, 'assets', src.id), { reserved: newReserved });
                    }

                    await batch.commit();
                } catch (e) {
                    console.error('Lá»—i chuyá»ƒn kho/kháº¥u trá»« reserved sau COMPLETED:', e);
                }
            }

            // Optimistic UI
            const signatureLocal = {
                uid: currentUser.uid,
                name: currentUser.displayName || currentUser.email || 'NgÆ°á»i kĂ½',
                signedAt: new Date().toISOString(),
            };

            setTransfers((prev) =>
                prev.map((it) =>
                    it.id === t.id
                        ? {
                            ...it,
                            status: nextStatus,
                            signatures: { ...(it.signatures || {}), [role]: signatureLocal },
                        }
                        : it
                )
            );

            setSelectedTransfer((prev) =>
                prev && prev.id === t.id
                    ? {
                        ...prev,
                        status: nextStatus,
                        signatures: { ...(prev.signatures || {}), [role]: signatureLocal },
                    }
                    : prev
            );

            setToast({ open: true, msg: 'ÄĂ£ kĂ½ duyá»‡t thĂ nh cĂ´ng.', severity: 'success' });
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: e?.message || 'KĂ½ tháº¥t báº¡i.', severity: 'error' });
        } finally {
            setSigning((s) => ({ ...s, [t.id]: false }));
        }
    };
    // ==========================================================
    // 4. KHU Vá»°C TĂNH TOĂN Dá»® LIá»†U PHĂI SINH (DERIVED DATA)
    // (useMemo) - âœ… ÄĂ‚Y LĂ€ Vá» TRĂ LĂ TÆ¯á»NG NHáº¤T
    // ==========================================================


    // File: src/pages/AssetTransferPage.jsx

    // THAY THáº¾ TOĂ€N Bá»˜ KHá»I useMemo CÅ¨ Báº°NG KHá»I NĂ€Y
    const actionableItems = useMemo(() => {
        if (!currentUser) return { transfers: [], requests: [], reports: [], total: 0 };

        const myTurnTransfers = transfers.filter(isMyTurn);
        const myTurnRequests = requestsWithDeptName.filter(canProcessRequest);
        // âœ… THAY Äá»”I: DĂ¹ng `reportsWithDeptName` thay vĂ¬ `inventoryReports`
        const myTurnReports = reportsWithDeptName.filter(canProcessReport);

        return {
            transfers: myTurnTransfers,
            requests: myTurnRequests,
            reports: myTurnReports,
            total: myTurnTransfers.length + myTurnRequests.length + myTurnReports.length,
        };
    }, [transfers, requestsWithDeptName, reportsWithDeptName, isMyTurn, canProcessRequest, canProcessReport, currentUser]);
    // âœ… BÆ¯á»C 2: Khai bĂ¡o stats SAU, vĂ¬ nĂ³ dĂ¹ng actionableItems
    const stats = useMemo(() => {
        // BĂ¢y giá» actionableItems Ä‘Ă£ tá»“n táº¡i vĂ  cĂ³ thá»ƒ truy cáº­p an toĂ n
        const totalMyTurn = actionableItems.total;

        const pendingTransfers = transfers.filter(t => t.status !== 'COMPLETED').length;
        const pendingRequests = assetRequests.filter(r => r.status !== 'COMPLETED' && r.status !== 'REJECTED').length;
        const pendingReports = inventoryReports.filter(r => r.status !== 'COMPLETED' && r.status !== 'REJECTED').length;
        const totalPending = pendingTransfers + pendingRequests + pendingReports;

        const totalAssets = assets.length;

        return [
            {
                label: 'Chá» tĂ´i xá»­ lĂ½',
                value: totalMyTurn,
                icon: <Inbox />,
                color: 'primary',
                // Giá»¯ nguyĂªn
                onClick: () => setTabIndex(0)
            },
            {
                label: 'CĂ´ng viá»‡c Ä‘ang xá»­ lĂ½',
                value: totalPending,
                icon: <Clock />,
                color: 'warning',
                // âœ… FIX: Chuyá»ƒn vá» Dashboard (Tab 0) vĂ¬ Ä‘Ă³ lĂ  nÆ¡i hiá»ƒn thá»‹ Táº¤T Cáº¢ cĂ´ng viá»‡c Ä‘ang xá»­ lĂ½
                onClick: () => setTabIndex(0)
            },
            {
                label: 'Tá»•ng sá»‘ loáº¡i tĂ i sáº£n',
                value: totalAssets,
                icon: <Warehouse />,
                color: 'info',
                // âœ… Má»I: Click Ä‘á»ƒ nháº£y ngay Ä‘áº¿n danh sĂ¡ch tĂ i sáº£n
                onClick: () => setTabIndex(2)
            },

        ];
    }, [actionableItems, transfers, assetRequests, inventoryReports, assets, setTabIndex]); // Bá»• sung setTabIndex vĂ o dependency array
    const revertStockMove = async (t) => {
        const batch = writeBatch(db);

        const fromId = t.fromDeptId || departments.find(d => d.name === t.from)?.id || null;
        const toId = t.toDeptId || departments.find(d => d.name === t.to)?.id || null;

        const assetMap = new Map(assets.map(a => [a.id, a]));
        const key = (x) =>
            [(x?.name || '').trim().toLowerCase(),
            (x?.unit || '').trim().toLowerCase(),
            (x?.size || '').trim().toLowerCase()].join('||');

        for (const item of (t.assets || [])) {
            const src = assetMap.get(item.id);
            if (!src) continue;

            const qty = Number(item.quantity || 0);
            const srcQty = Number(src.quantity || 0);

            // doc tÆ°Æ¡ng á»©ng á»Ÿ phĂ²ng Ä‘Ă­ch (náº¿u cĂ³, vĂ  cĂ³ thá»ƒ lĂ  doc khĂ¡c vá»›i src)
            const destAtTo = assets.find(a => a.departmentId === toId && key(a) === key(src));
            const sameDoc = destAtTo && destAtTo.id === src.id;

            const movedAllByChangingDept =
                qty >= srcQty && src.departmentId === toId; // trÆ°á»›c Ä‘Ă³ chuyá»ƒn háº¿t -> chá»‰ Ä‘á»•i departmentId

            if (movedAllByChangingDept) {
                // Chá»‰ tráº£ departmentId vá» phĂ²ng nguá»“n. KHĂ”NG trá»«/Ä‘á»•i gĂ¬ khĂ¡c trĂªn cĂ¹ng doc.
                batch.update(doc(db, 'assets', src.id), { departmentId: fromId });
                continue;
            }

            // TrÆ°á»ng há»£p chuyá»ƒn má»™t pháº§n:
            // 1) Trá»« á»Ÿ phĂ²ng Ä‘Ă­ch (chá»‰ khi lĂ  doc KHĂC doc src)
            if (destAtTo && !sameDoc) {
                const newQty = Math.max(0, Number(destAtTo.quantity || 0) - qty);
                if (newQty === 0) {
                    batch.delete(doc(db, 'assets', destAtTo.id));
                } else {
                    batch.update(doc(db, 'assets', destAtTo.id), { quantity: newQty });
                }
            }

            // 2) Cá»™ng tráº£ vá» phĂ²ng nguá»“n (gá»™p theo name+unit+size)
            const existingBackToFrom = assets.find(
                (a) => a.departmentId === fromId && key(a) === key(src)
            );

            if (existingBackToFrom) {
                batch.update(doc(db, 'assets', existingBackToFrom.id), {
                    quantity: Number(existingBackToFrom.quantity || 0) + qty,
                });
            } else {
                batch.set(doc(collection(db, 'assets')), {
                    name: src?.name,
                    size: src?.size || '',
                    description: src?.description || '',
                    unit: src?.unit,
                    quantity: qty,
                    notes: src?.notes || '',
                    departmentId: fromId,
                });
            }
        }

        await batch.commit();
    };


    const deleteTransfer = async (t) => {
        handleCloseDetailView();
        setSigning(s => ({ ...s, [t.id]: true }));

        try {
            if (t.status === 'COMPLETED') {
                // 1) HoĂ n tĂ¡c kho trÆ°á»›c
                await revertStockMove(t);
                // 2) XĂ³a phiáº¿u
                await deleteDoc(doc(db, 'transfers', t.id));
                setToast({
                    open: true,
                    msg: 'ÄĂ£ xĂ³a phiáº¿u vĂ  hoĂ n tĂ¡c di chuyá»ƒn kho vá» phĂ²ng cÅ©.',
                    severity: 'success'
                });
                return;
            }

            // ChÆ°a COMPLETED: chá»‰ tráº£ reserved nhÆ° cÅ©
            await runTransaction(db, async (tx) => {
                for (const item of (t.assets || [])) {
                    const qty = Number(item.quantity || 0);
                    if (qty > 0) {
                        const assetRef = doc(db, 'assets', item.id);
                        const assetSnap = await tx.get(assetRef);
                        if (assetSnap.exists()) {
                            tx.update(assetRef, { reserved: increment(-qty) });
                        }
                    }
                }
                tx.delete(doc(db, 'transfers', t.id));
            });

            setToast({ open: true, msg: 'ÄĂ£ xĂ³a phiáº¿u vĂ  tráº£ láº¡i tá»“n kháº£ dá»¥ng.', severity: 'success' });
            setUndo({ open: true, transfer: t }); // váº«n cho hoĂ n tĂ¡c náº¿u muá»‘n
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: 'XĂ³a phiáº¿u tháº¥t báº¡i: ' + e.message, severity: 'error' });
        } finally {
            setSigning(s => ({ ...s, [t.id]: false }));
        }
    };

    const handleUndoDelete = async () => {
        const t = undo.transfer; if (!t) return;
        try {
            const ref = doc(collection(db, "transfers"));
            await runTransaction(db, async (tx) => {
                if (t.status !== "COMPLETED") {
                    for (const item of (t.assets || [])) {
                        const aRef = doc(db, "assets", item.id);
                        const aSnap = await tx.get(aRef);
                        if (!aSnap.exists()) throw new Error(`TĂ i sáº£n khĂ´ng tá»“n táº¡i: ${item.name}`);
                        const aData = aSnap.data();
                        const qty = Number(aData.quantity || 0);
                        const res = Number(aData.reserved || 0);
                        const avail = qty - res;
                        const need = Number(item.quantity || 0);
                        if (need > avail) throw new Error(`KhĂ´ng Ä‘á»§ tá»“n kháº£ dá»¥ng Ä‘á»ƒ hoĂ n tĂ¡c "${item.name}".`);
                        tx.update(aRef, { reserved: increment(need) });
                    }
                }
                const { id, ...payload } = t;
                tx.set(ref, { ...payload, date: serverTimestamp() });
            });

            setUndo({ open: false, transfer: null });
            setToast({ open: true, msg: "ÄĂ£ hoĂ n tĂ¡c xĂ³a phiáº¿u.", severity: "success" });
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: "HoĂ n tĂ¡c tháº¥t báº¡i.", severity: "error" });
        }
    };


    // THAY THáº¾ TOĂ€N Bá»˜ HĂ€M NĂ€Y Báº°NG PHIĂN Báº¢N Gá»ŒN HÆ N
    const handleCreatePrintRequest = async () => {
        if (!currentUser) {
            return setToast({ open: true, msg: "Vui lĂ²ng Ä‘Äƒng nháº­p.", severity: "warning" });
        }

        if (!printType || (printType === 'block' && !selectedBlockForPrint)) {
            return setToast({ open: true, msg: "Vui lĂ²ng chá»n Ä‘áº§y Ä‘á»§ thĂ´ng tin bĂ¡o cĂ¡o.", severity: "warning" });
        }

        setIsCreatingReport(true);

        try {
            const createReportCallable = httpsCallable(functions, 'createInventoryReport');
            let payload;

            if (printType === 'block') {
                payload = {
                    type: 'BLOCK_INVENTORY',
                    blockName: selectedBlockForPrint
                };
            } else { // 'summary'
                payload = { type: 'SUMMARY_REPORT' };
            }

            const result = await createReportCallable(payload);
            setToast({ open: true, msg: `ÄĂ£ táº¡o yĂªu cáº§u bĂ¡o cĂ¡o ${result.data.displayId} thĂ nh cĂ´ng.`, severity: "success" });
            setIsPrintModalOpen(false);
            setTabIndex(4);
        } catch (error) {
            console.error("Lá»—i khi táº¡o yĂªu cáº§u bĂ¡o cĂ¡o:", error);
            setToast({ open: true, msg: "CĂ³ lá»—i xáº£y ra: " + error.message, severity: "error" });
        } finally {
            setIsCreatingReport(false);
        }
    };
    const handleCreateTransfer = async () => {
        if (!currentUser) return setToast({ open: true, msg: "Vui lĂ²ng Ä‘Äƒng nháº­p.", severity: "warning" });
        if (creating) return;
        setCreating(true);

        const fromDepartment = departments.find((d) => d.id === fromDept);
        const toDepartment = departments.find((d) => d.id === toDept);
        if (!fromDepartment || !toDepartment || selectedAssets.length === 0) {
            setCreating(false);
            return setToast({ open: true, msg: "Vui lĂ²ng chá»n Ä‘á»§ thĂ´ng tin phiáº¿u.", severity: "warning" });
        }
        const chosen = assetsWithAvailability.filter((a) => selectedAssets.includes(a.id));
        // (Báº¡n cĂ³ thá»ƒ giá»¯ láº¡i vĂ²ng láº·p for Ä‘á»ƒ kiá»ƒm tra sá»‘ lÆ°á»£ng á»Ÿ client cho nhanh)

        try {
            if (!createNonce) throw new Error("Thiáº¿u mĂ£ phiĂªn táº¡o phiáº¿u. Vui lĂ²ng má»Ÿ láº¡i form.");
            const assetsToTransfer = chosen.map((a) => ({
                id: a.id, name: a.name, unit: a.unit,
                quantity: Number(selectedQuantities[a.id] || 1),
            }));

            const createTransferCallable = httpsCallable(functions, 'createTransfer');
            const result = await createTransferCallable({
                fromDeptId: fromDept,
                toDeptId: toDept,
                assets: assetsToTransfer,
                nonce: createNonce,
            });

            setIsTransferModalOpen(false);
            setToast({ open: true, msg: `ÄĂ£ táº¡o phiáº¿u thĂ nh cĂ´ng: ${result.data.displayId}`, severity: "success" });
            setCreateNonce("");
        } catch (e) {
            console.error("Lá»—i khi gá»i createTransfer function:", e);
            setToast({ open: true, msg: e?.message || "Lá»—i khi táº¡o phiáº¿u tá»« server.", severity: "error" });
        } finally {
            setCreating(false);
        }
    };

    // src/pages/AssetTransferPage.jsx (khoáº£ng dĂ²ng 1729)

    // âœ… TĂCH HĂ€M NĂ€Y RA Äá»‚ TĂI Sá»¬ Dá»¤NG
    const callCreateAssetRequest = async (type, assetData, targetId = null, quantity = null) => {
        if (!currentUser) {
            throw new Error("Vui lĂ²ng Ä‘Äƒng nháº­p.");
        }

        // TĂ¬m phĂ²ng ban (cho dĂ¹ lĂ  thĂªm má»›i hay tÄƒng sá»‘ lÆ°á»£ng)
        const deptId = assetData?.departmentId;
        const selectedDept = departments.find(d => d.id === deptId);
        if (!selectedDept) {
            throw new Error("PhĂ²ng ban khĂ´ng há»£p lá»‡.");
        }

        const createRequestCallable = httpsCallable(functions, 'createAssetRequest');
        let payload;

        if (type === "ADD") {
            payload = {
                type: "ADD",
                assetData: {
                    ...assetData,
                    managementBlock: selectedDept.managementBlock || null,
                }
            };
        } else if (type === "INCREASE_QUANTITY") {
            payload = {
                type: "INCREASE_QUANTITY",
                targetAssetId: targetId,
                quantity: Number(quantity),
                assetData: { // Gá»­i kĂ¨m thĂ´ng tin Ä‘á»ƒ hiá»ƒn thá»‹
                    name: assetData.name,
                    unit: assetData.unit,
                    size: assetData.size,
                    departmentId: assetData.departmentId,
                    managementBlock: selectedDept.managementBlock || null,
                }
            };
        } else {
            throw new Error("Loáº¡i yĂªu cáº§u khĂ´ng xĂ¡c Ä‘á»‹nh.");
        }

        const result = await createRequestCallable(payload);
        setToast({ open: true, msg: `ÄĂ£ gá»­i yĂªu cáº§u ${result.data.displayId} thĂ nh cĂ´ng.`, severity: "success" });
        setTabIndex(3); // Chuyá»ƒn sang tab YĂªu cáº§u
    };

    // âœ… THAY THáº¾ HĂ€M handleSaveAsset CÅ¨ Báº°NG HĂ€M Má»I NĂ€Y
    // âœ… THAY THáº¾ HĂ€M handleSaveAsset CÅ¨ Báº°NG HĂ€M Má»I NĂ€Y (Sá»¬ Dá»¤NG REACT HOOK FORM)
    const onSubmitAsset = async (data) => {
        // data Ä‘Ă£ Ä‘Æ°á»£c validate bá»Ÿi Zod
        try {
            if (modalMode === "add") {
                // BÆ¯á»C 1: Kiá»ƒm tra trĂ¹ng láº·p
                const existingDoc = await checkDuplicate(data);

                if (existingDoc) {
                    // BÆ¯á»C 2A: ÄĂƒ Tá»’N Táº I -> Má»Ÿ Dialog xĂ¡c nháº­n
                    setConfirmation({
                        newAsset: data,
                        existingDoc: existingDoc.data(),
                        existingDocId: existingDoc.id
                    });
                    setIsAssetModalOpen(false); // ÄĂ³ng modal thĂªm
                } else {
                    // BÆ¯á»C 2B: CHÆ¯A Tá»’N Táº I -> Gá»­i yĂªu cáº§u "ADD" nhÆ° cÅ©
                    await callCreateAssetRequest("ADD", data);
                    setIsAssetModalOpen(false);
                }
            } else {
                // Cháº¿ Ä‘á»™ "EDIT" (Admin sá»­a trá»±c tiáº¿p) -> Giá»¯ nguyĂªn logic cÅ©
                if (currentUser?.role !== 'admin') {
                    throw new Error("Chá»‰ Admin má»›i Ä‘Æ°á»£c phĂ©p sá»­a trá»±c tiáº¿p.");
                }
                const selectedDept = departments.find(d => d.id === data.departmentId);
                const updatedAssetData = {
                    ...data,
                    managementBlock: selectedDept?.managementBlock || null,
                };
                await updateDoc(doc(db, "assets", data.id), updatedAssetData);
                setToast({ open: true, msg: "ÄĂ£ cáº­p nháº­t tĂ i sáº£n.", severity: "success" });
                setIsAssetModalOpen(false);
            }
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: "Lá»—i khi xá»­ lĂ½: " + e.message, severity: "error" });
        }
    };
    const handleConfirmReduceQuantity = async () => {
        if (!reduceQuantityTarget || !currentUser || quantityToDelete <= 0) return;

        try {
            const createRequestCallable = httpsCallable(functions, 'createAssetRequest');
            const payload = {
                type: "REDUCE_QUANTITY", // <-- TYPE Má»I
                targetAssetId: reduceQuantityTarget.id,
                quantity: Number(quantityToDelete), // <-- Sá»‘ lÆ°á»£ng cáº§n giáº£m
            };

            const result = await createRequestCallable(payload);

            setReduceQuantityTarget(null); // ÄĂ³ng dialog
            setToast({ open: true, msg: `ÄĂ£ gá»­i yĂªu cáº§u giáº£m sá»‘ lÆ°á»£ng ${result.data.displayId}.`, severity: "success" });
            setTabIndex(3); // Chuyá»ƒn sang tab YĂªu cáº§u Ä‘á»ƒ ngÆ°á»i dĂ¹ng tháº¥y
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: "Lá»—i khi táº¡o yĂªu cáº§u giáº£m sá»‘ lÆ°á»£ng: " + e.message, severity: "error" });
        }
    };

    // âœ… Báº N HĂƒY Äáº¶T HĂ€M Má»I VĂ€O NGAY ÄĂ‚Y
    const handleConfirmUpdateDates = async () => {
        if (!newCheckDate || selectedAssetIdsForPrint.length === 0 || !canManageAssets) {
            return setToast({ open: true, msg: "KhĂ´ng cĂ³ ngĂ y hoáº·c tĂ i sáº£n nĂ o Ä‘Æ°á»£c chá»n.", severity: "warning" });
        }

        setIsUpdatingDates(true);
        try {
            const assetIds = selectedAssetIdsForPrint;
            const newDateISO = newCheckDate.toISOString();

            const batchUpdateDatesCallable = httpsCallable(functions, 'batchUpdateAssetDates');
            const result = await batchUpdateDatesCallable({
                assetIds: assetIds,
                newCheckDate: newDateISO
            });

            setToast({ open: true, msg: result.data.message, severity: "success" });

            setIsUpdateDateModalOpen(false);
            setNewCheckDate(null);
            setSelectedAssetIdsForPrint([]);

        } catch (error) {
            console.error("Lá»—i khi gá»i hĂ m cáº­p nháº­t ngĂ y:", error);
            setToast({ open: true, msg: "Cáº­p nháº­t tháº¥t báº¡i: " + error.message, severity: "error" });
        } finally {
            setIsUpdatingDates(false);
        }
    };


    const handleDeleteAsset = async () => {
        if (!deleteConfirm || !currentUser) return;

        const assetToDelete = deleteConfirm;

        // âœ… BÆ¯á»C 1: Báº­t tráº¡ng thĂ¡i loading
        setIsProcessingRequest(prev => ({ ...prev, [assetToDelete.id]: true }));

        // Logic kiá»ƒm tra phiáº¿u yĂªu cáº§u Ä‘Ă£ tá»“n táº¡i (giá»¯ nguyĂªn)
        if (assetToDelete.quantity === 1) {
            const existingRequest = assetRequests.find(req =>
                req.type === 'DELETE' &&
                req.targetAssetId === assetToDelete.id &&
                !['COMPLETED', 'REJECTED'].includes(req.status)
            );

            if (existingRequest) {
                setToast({
                    open: true,
                    msg: `Phiáº¿u yĂªu cáº§u xĂ³a Ä‘Ă£ tá»“n táº¡i: ${existingRequest.maPhieuHienThi || '#' + shortId(existingRequest.id)}`,
                    severity: 'info'
                });
                setDeleteConfirm(null);
                // âœ… BÆ¯á»C 2: Táº¯t loading náº¿u dá»«ng sá»›m
                setIsProcessingRequest(prev => ({ ...prev, [assetToDelete.id]: false }));
                return;
            }
        }

        try {
            const createRequestCallable = httpsCallable(functions, 'createAssetRequest');
            const payload = { type: "DELETE", targetAssetId: assetToDelete.id };
            const result = await createRequestCallable(payload);

            setToast({ open: true, msg: `ÄĂ£ gá»­i yĂªu cáº§u xĂ³a ${result.data.displayId}.`, severity: "success" });
            setTabIndex(3); // Chuyá»ƒn sang tab YĂªu cáº§u Ä‘á»ƒ ngÆ°á»i dĂ¹ng tháº¥y
        } catch (e) {
            console.error(e);
            setToast({ open: true, msg: "Lá»—i khi táº¡o yĂªu cáº§u xĂ³a: " + e.message, severity: "error" });
        } finally {
            // âœ… BÆ¯á»C 3: LuĂ´n táº¯t loading dĂ¹ thĂ nh cĂ´ng hay tháº¥t báº¡i
            setIsProcessingRequest(prev => ({ ...prev, [assetToDelete.id]: false }));
            setDeleteConfirm(null); // ÄĂ³ng dialog
        }
    };

    const handlePasteAndSave = async () => {
        if (!pastedText.trim() || filterDeptsForAsset.length !== 1) {
            return setToast({ open: true, msg: "Vui lĂ²ng dĂ¡n dá»¯ liá»‡u vĂ  chá»n CHá»ˆ Má»˜T phĂ²ng ban.", severity: "warning" });
        }
        const targetDepartmentId = filterDeptsForAsset[0];

        setCreating(true);

        try {
            const selectedDept = departments.find(d => d.id === targetDepartmentId);
            if (!selectedDept) {
                throw new Error("PhĂ²ng ban Ä‘Ă£ chá»n khĂ´ng há»£p lá»‡. Vui lĂ²ng thá»­ láº¡i.");
            }

            const rows = pastedText.trim().split('\n').filter(row => row.trim() !== "");
            if (rows.length === 0) throw new Error("KhĂ´ng cĂ³ dá»¯ liá»‡u há»£p lá»‡.");

            const assetsData = rows.map((row, index) => {
                const columns = row.split('\t');
                const quantity = Number(columns[3]?.trim() || 0);
                if (!columns[0] || !columns[2] || isNaN(quantity) || quantity <= 0) {
                    throw new Error(`DĂ²ng ${index + 1} thiáº¿u thĂ´ng tin hoáº·c sá»‘ lÆ°á»£ng khĂ´ng há»£p lá»‡.`);
                }
                return {
                    name: columns[0]?.trim() || "",
                    size: columns[1]?.trim() || "",
                    unit: columns[2]?.trim() || "",
                    quantity: quantity,
                    notes: columns[4]?.trim() || "",
                    departmentId: targetDepartmentId,
                    managementBlock: selectedDept.managementBlock || null,
                };
            });

            const batchAddAssetsCallable = httpsCallable(functions, 'batchAddAssetsDirectly');

            // âœ… THAY Äá»”I 1: Láº¥y `result` tráº£ vá»
            const result = await batchAddAssetsCallable({ assetsData: assetsData });

            // âœ… THAY Äá»”I 2: DĂ¹ng `result.data.message` Ä‘á»ƒ hiá»ƒn thá»‹ thĂ´ng bĂ¡o
            setToast({
                open: true,
                msg: result.data.message, // (VD: "ÄĂ£ thĂªm 90 tĂ i sáº£n má»›i. 10 tĂ i sáº£n bá»‹ bá» qua...")
                severity: "success"
            });

            setIsPasteModalOpen(false);
            setPastedText("");

        } catch (error) {
            console.error("Lá»—i khi nháº­p hĂ ng loáº¡t trá»±c tiáº¿p:", error);
            setToast({ open: true, msg: "CĂ³ lá»—i xáº£y ra: " + error.message, severity: "error" });
        } finally {
            setCreating(false); // Táº¯t tráº¡ng thĂ¡i loading dĂ¹ thĂ nh cĂ´ng hay tháº¥t báº¡i
        }
    };

    const handleProcessRequest = async (req, action) => {
        if (isProcessingRequest[req.id]) return;
        setIsProcessingRequest(prev => ({ ...prev, [req.id]: true }));

        try {
            const processAssetRequest = httpsCallable(functions, 'processAssetRequest');
            const result = await processAssetRequest({ requestId: req.id, action });
            setToast({ open: true, msg: result.data.message, severity: "success" });
        } catch (error) {
            console.error("Lá»—i khi xá»­ lĂ½ yĂªu cáº§u:", error);
            setToast({ open: true, msg: error.message, severity: "error" });
        } finally {
            // LuĂ´n táº¯t loading Ä‘á»ƒ cho phĂ©p hĂ nh Ä‘á»™ng tiáº¿p theo
            setIsProcessingRequest(prev => ({ ...prev, [req.id]: false }));
        }
    };
    // âœ… Báº N HĂƒY Äáº¶T HĂ€M Má»I VĂ€O NGAY ÄĂ‚Y
    const handleDeleteRequest = async () => {
        const req = deleteRequestConfirm;
        if (!req || isProcessingRequest[req.id]) return;

        setIsProcessingRequest(prev => ({ ...prev, [req.id]: true }));
        try {
            const deleteAssetRequest = httpsCallable(functions, 'deleteAssetRequest');
            const result = await deleteAssetRequest({ requestId: req.id });
            setToast({ open: true, msg: result.data.message, severity: "success" });
        } catch (error) {
            console.error("Lá»—i khi xĂ³a yĂªu cáº§u:", error);
            setToast({ open: true, msg: error.message, severity: "error" });
        } finally {
            setIsProcessingRequest(prev => ({ ...prev, [req.id]: false }));
            setDeleteRequestConfirm(null); // ÄĂ³ng dialog
        }
    };

    const handleOpenReportDetail = (report) => {
        console.log("Opening report:", report); // <-- THĂM DĂ’NG NĂ€Y

        setSelectedReport(report);
        setIsReportDetailOpen(true);
    };

    const handleCloseReportDetail = () => {
        setSelectedReport(null);
        setIsReportDetailOpen(false);
    };

    const handleSignReport = async (report) => {
        if (!currentUser || processingReport[report.id]) return;

        const workflow = reportWorkflows[report.type];
        if (!workflow) {
            setToast({ open: true, msg: "Loáº¡i bĂ¡o cĂ¡o khĂ´ng há»£p lá»‡.", severity: "error" });
            return;
        }

        const currentStepIndex = workflow.findIndex(step => step.status === report.status);
        if (currentStepIndex === -1) {
            setToast({ open: true, msg: "Tráº¡ng thĂ¡i bĂ¡o cĂ¡o khĂ´ng há»£p lá»‡.", severity: "error" });
            return;
        }

        setProcessingReport(prev => ({ ...prev, [report.id]: true }));

        try {
            const reportRef = doc(db, "inventory_reports", report.id);

            const signature = {
                uid: currentUser.uid,
                name: currentUser.displayName || currentUser.email,
                signedAt: serverTimestamp(),
            };

            const nextStatus = (currentStepIndex < workflow.length - 1)
                ? workflow[currentStepIndex + 1].status
                : "COMPLETED";

            const signatureKey = workflow[currentStepIndex].signatureKey;

            await updateDoc(reportRef, {
                status: nextStatus,
                [`signatures.${signatureKey}`]: signature,
            });

            setToast({ open: true, msg: "ÄĂ£ kĂ½ duyá»‡t thĂ nh cĂ´ng.", severity: "success" });
            if (selectedReport?.id === report.id) {
                handleCloseReportDetail();
            }

        } catch (error) {
            console.error("Lá»—i khi kĂ½ duyá»‡t bĂ¡o cĂ¡o:", error);
            setToast({ open: true, msg: "CĂ³ lá»—i xáº£y ra, vui lĂ²ng thá»­ láº¡i.", severity: "error" });
        } finally {
            setProcessingReport(prev => ({ ...prev, [report.id]: false }));
        }
    };

    // >>> Báº N NĂN Äáº¶T HĂ€M Má»I VĂ€O ÄĂ‚Y <<<
    const handleRejectReport = async () => {
        const report = rejectReportConfirm;
        if (!report || !currentUser || processingReport[report.id]) return;

        setProcessingReport(prev => ({ ...prev, [report.id]: true }));
        try {
            await updateDoc(doc(db, "inventory_reports", report.id), {
                status: "REJECTED",
                rejectedBy: {
                    uid: currentUser.uid,
                    name: currentUser.displayName || currentUser.email,
                    rejectedAt: serverTimestamp(),
                }
            });
            setToast({ open: true, msg: "ÄĂ£ tá»« chá»‘i bĂ¡o cĂ¡o.", severity: "success" });
        } catch (error) {
            console.error("Lá»—i khi tá»« chá»‘i bĂ¡o cĂ¡o:", error);
            setToast({ open: true, msg: "CĂ³ lá»—i xáº£y ra, vui lĂ²ng thá»­ láº¡i.", severity: "error" });
        } finally {
            setProcessingReport(prev => ({ ...prev, [report.id]: false }));
            setRejectReportConfirm(null);
        }
    };


    const handleDeleteReport = async () => {
        const report = deleteReportConfirm;
        if (!report) return;
        try {
            await deleteDoc(doc(db, "inventory_reports", report.id));
            setToast({ open: true, msg: "ÄĂ£ xĂ³a bĂ¡o cĂ¡o thĂ nh cĂ´ng.", severity: "success" });
            // refresh láº¡i danh sĂ¡ch bĂ¡o cĂ¡o náº¿u cáº§n
        } catch (e) {
            console.error("Delete report error:", e);
            setToast({ open: true, msg: "XĂ³a bĂ¡o cĂ¡o tháº¥t báº¡i.", severity: "error" });
        } finally {
            setDeleteReportConfirm(null);
        }
    };

    // Render functions... (giá»¯ nguyĂªn renderActionButtons, StatCardSkeleton, TransferSkeleton)
    // ...
    // Äáº·t hĂ m nĂ y gáº§n renderActionButtons cÅ©
    const TransferActionButtons = ({ transfer }) => {
        if (!currentUser) return null;

        // Logic cho Admin
        if (currentUser.role === 'admin') {
            let roleToSign, label, icon, color = 'primary';
            if (transfer.status === "PENDING_SENDER") { roleToSign = "sender"; label = "KĂ½ chuyá»ƒn"; icon = <FilePen size={16} />; }
            else if (transfer.status === "PENDING_RECEIVER") { roleToSign = "receiver"; label = "KĂ½ nháº­n"; icon = <UserCheck size={16} />; color = 'info'; }
            else if (transfer.status === "PENDING_ADMIN") { roleToSign = "admin"; label = "Duyá»‡t HC"; icon = <Handshake size={16} />; color = 'secondary'; }

            if (roleToSign) {
                return (
                    <Button variant="contained" size="small" color={color} startIcon={icon} disabled={signing[transfer.id]} onClick={(e) => { e.stopPropagation(); handleSign(transfer, roleToSign); }}>
                        {signing[transfer.id] ? "..." : label}
                    </Button>
                );
            }
            return null; // KhĂ´ng cĂ³ action gĂ¬ cho admin á»Ÿ tráº¡ng thĂ¡i COMPLETED
        }

        // Logic cho ngÆ°á»i dĂ¹ng thÆ°á»ng
        if (transfer.status === "PENDING_SENDER" && canSignSender(transfer)) {
            return <Button variant="contained" size="small" startIcon={<FilePen size={16} />} disabled={signing[transfer.id]} onClick={(e) => { e.stopPropagation(); handleSign(transfer, "sender"); }}>{signing[transfer.id] ? "..." : "KĂ½ chuyá»ƒn"}</Button>;
        }
        if (transfer.status === "PENDING_RECEIVER" && canSignReceiver(transfer)) {
            return <Button variant="contained" size="small" color="info" startIcon={<UserCheck size={16} />} disabled={signing[transfer.id]} onClick={(e) => { e.stopPropagation(); handleSign(transfer, "receiver"); }}>{signing[transfer.id] ? "..." : "KĂ½ nháº­n"}</Button>;
        }
        if (transfer.status === "PENDING_ADMIN" && canSignAdmin(transfer)) {
            return <Button variant="contained" size="small" color="secondary" startIcon={<Handshake size={16} />} disabled={signing[transfer.id]} onClick={(e) => { e.stopPropagation(); handleSign(transfer, "admin"); }}>{signing[transfer.id] ? "..." : "Duyá»‡t HC"}</Button>;
        }

        return null;
    };
    /* ---------- Action buttons for Detail View ---------- */
    const renderActionButtons = (t) => {
        if (!currentUser || !t) return null;
        const common = {
            size: "medium",
            variant: "contained",
            fullWidth: true,
        };

        // Admin cĂ³ thá»ƒ kĂ½ thay cho má»i bÆ°á»›c
        if (currentUser?.role === "admin") {
            if (t.status === "PENDING_SENDER") {
                return (
                    <Button {...common} startIcon={<FilePen size={16} />} onClick={() => handleSign(t, "sender")}>
                        KĂ½ thay P. Chuyá»ƒn
                    </Button>
                );
            }
            if (t.status === "PENDING_RECEIVER") {
                return (
                    <Button {...common} color="info" startIcon={<UserCheck size={16} />} onClick={() => handleSign(t, "receiver")}>
                        KĂ½ thay P. Nháº­n
                    </Button>
                );
            }
            if (t.status === "PENDING_ADMIN") {
                return (
                    <Button {...common} color="secondary" startIcon={<Handshake size={16} />} onClick={() => handleSign(t, "admin")}>
                        XĂ¡c nháº­n (P.HC)
                    </Button>
                );
            }
        }

        // NgÆ°á»i dĂ¹ng thÆ°á»ng: chá»‰ hiá»ƒn thá»‹ nĂºt khi Ä‘áº¿n lÆ°á»£t
        if (t.status === "PENDING_SENDER" && canSignSender(t)) {
            return (
                <Button {...common} startIcon={<FilePen size={16} />} onClick={() => handleSign(t, "sender")}>
                    KĂ½ phĂ²ng chuyá»ƒn
                </Button>
            );
        }
        if (t.status === "PENDING_RECEIVER" && canSignReceiver(t)) {
            return (
                <Button {...common} color="info" startIcon={<UserCheck size={16} />} onClick={() => handleSign(t, "receiver")}>
                    KĂ½ phĂ²ng nháº­n
                </Button>
            );
        }
        if (t.status === "PENDING_ADMIN" && canSignAdmin(t)) {
            return (
                <Button {...common} color="secondary" startIcon={<Handshake size={16} />} onClick={() => handleSign(t, "admin")}>
                    XĂ¡c nháº­n (P.HC)
                </Button>
            );
        }

        // Máº·c Ä‘á»‹nh: Hiá»ƒn thá»‹ tráº¡ng thĂ¡i, khĂ´ng cho hĂ nh Ä‘á»™ng
        const buttonText = t.status === 'COMPLETED' ? "ÄĂ£ hoĂ n thĂ nh" : "Chá» bÆ°á»›c káº¿ tiáº¿p";
        return (
            <Button {...common} disabled startIcon={t.status === 'COMPLETED' ? <Check size={16} /> : <Clock size={16} />}>
                {buttonText}
            </Button>
        );
    };    /* ---------- Skeletons ---------- */
    const StatCardSkeleton = () => (
        <Paper variant="outlined" sx={{ p: 2.5, borderRadius: 3 }}>
            <Skeleton width="60%" height={30} />
            <Skeleton width="40%" height={20} sx={{ mt: 1 }} />
        </Paper>
    );
    const TransferSkeleton = () => (
        <Card variant="outlined" sx={{ p: 2.5, borderRadius: 3 }}>
            <Stack direction="row" justifyContent="space-between">
                <Skeleton width="40%" height={28} />
                <Skeleton width={100} height={24} sx={{ borderRadius: 1 }} />
            </Stack>
            <Skeleton height={18} sx={{ my: 1.5 }} />
            <Skeleton height={18} />
            <Divider sx={{ my: 1.5 }} />
            <Stack direction="row" justifyContent="space-between">
                <Skeleton width="30%" height={20} />
                <Skeleton width="50%" height={20} />
            </Stack>
        </Card>
    );
    // âœ… TransferTableRowMobile imported from components/assets/TransferTableRowMobile.jsx

    // âœ… RequestTableRowMobile imported from components/assets/RequestTableRowMobile.jsx
    // âœ… ReportTableRowMobile imported from components/assets/ReportTableRowMobile.jsx

    const DashboardTableRowMobile = ({ item, type, onDetailClick }) => {
        let typeLabel, statusLabel, statusColor, typeIcon, displayStatus;
        let mainTitle, subText, maPhieu;

        if (type === 'TRANSFERS') {
            typeLabel = 'LuĂ¢n chuyá»ƒn';
            typeIcon = <ArrowRightLeft size={16} />;
            statusLabel = statusConfig[item.status]?.label;
            statusColor = statusConfig[item.status]?.color || 'default';
            displayStatus = statusConfig[item.status]?.icon;
            mainTitle = `${item.from} â†’ ${item.to}`;
            subText = `Táº¡o bá»Ÿi ${item.createdBy?.name}`;
            maPhieu = item.maPhieuHienThi || `#${shortId(item.id)}`;
        } else if (type === 'REQUESTS') {
            typeLabel = 'YĂªu cáº§u';
            typeIcon = item.type === 'ADD' ? <FilePlus size={16} /> : (item.type === 'DELETE' ? <FileX size={16} /> : <FilePen size={16} />);
            statusLabel = requestStatusConfig[item.status]?.label;
            statusColor = requestStatusConfig[item.status]?.color || 'default';
            displayStatus = requestStatusConfig[item.status]?.icon;
            mainTitle = item.assetData?.name;
            subText = `PhĂ²ng: ${item.departmentName}`;
            maPhieu = item.maPhieuHienThi || `#${shortId(item.id)}`;
        } else if (type === 'REPORTS') {
            typeLabel = 'BĂ¡o cĂ¡o';
            typeIcon = <Sheet size={16} />;
            statusLabel = reportStatusConfig[item.status]?.label;
            statusColor = reportStatusConfig[item.status]?.color || 'default';
            displayStatus = reportStatusConfig[item.status]?.icon;
            mainTitle = item.title;
            subText = `Pháº¡m vi: ${item.departmentName}`;
            maPhieu = item.maPhieuHienThi || `#${shortId(item.id)}`;
        } else {
            return null;
        }

        // Hiá»ƒn thá»‹ nĂºt hĂ nh Ä‘á»™ng náº¿u cĂ³ quyá»n xá»­ lĂ½ (chá»‰ cáº§n kiá»ƒm tra logic Ä‘Ă£ cĂ³)
        const canAct = (type === 'TRANSFERS' && isMyTurn(item)) ||
            (type === 'REQUESTS' && canProcessRequest(item)) ||
            (type === 'REPORTS' && canProcessReport(item));

        return (
            <Card variant="outlined" sx={{ mb: 1.5, borderRadius: 3 }} onClick={() => onDetailClick(item)}>
                <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>
                    {/* Header: MĂ£ phiáº¿u vĂ  Loáº¡i */}
                    <Stack direction="row" justifyContent="space-between" alignItems="center" spacing={1} sx={{ mb: 1.5 }}>
                        <Chip size="small" variant="outlined" label={maPhieu} sx={{ fontWeight: 600, bgcolor: 'grey.100' }} />
                        <Chip size="small" label={typeLabel} color="primary" icon={typeIcon} variant="outlined" />
                    </Stack>
                    <Divider sx={{ mb: 1.5 }} />

                    {/* Body: Ná»™i dung & Tráº¡ng thĂ¡i */}
                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                        <Box sx={{ flexGrow: 1, pr: 1 }}>
                            <Typography variant="body1" fontWeight={700}>{mainTitle}</Typography>
                            <Typography variant="caption" color="text.secondary">{subText}</Typography>
                        </Box>
                        <Chip
                            size="small"
                            label={statusLabel}
                            color={statusColor}
                            icon={displayStatus}
                            variant="outlined"
                        />
                    </Stack>
                </CardContent>

                {/* Actions (NĂºt báº¥m) */}
                {canAct && (
                    <>
                        <Divider />
                        <CardActions sx={{ bgcolor: 'grey.50', justifyContent: 'flex-end' }}>
                            {type === 'TRANSFERS' && <TransferActionButtons transfer={item} />}
                            {type === 'REQUESTS' && (
                                <Stack direction="row" spacing={1}>
                                    <Button size="small" color="error" onClick={(e) => { e.stopPropagation(); setRejectConfirm(item); }}>Tá»« chá»‘i</Button>
                                    <Button size="small" variant="contained" onClick={(e) => { e.stopPropagation(); handleProcessRequest(item, 'approve'); }} startIcon={<Check size={16} />}>Duyá»‡t</Button>
                                </Stack>
                            )}
                            {type === 'REPORTS' && (
                                <Stack direction="row" spacing={1}>
                                    <Button size="small" color="error" onClick={(e) => { e.stopPropagation(); setRejectReportConfirm(item); }}>Tá»« chá»‘i</Button>
                                    <Button size="small" variant="contained" onClick={(e) => { e.stopPropagation(); handleSignReport(item); }} startIcon={<Check size={16} />}>Duyá»‡t</Button>
                                </Stack>
                            )}
                            <Button size="small" endIcon={<ChevronRight />}>Chi tiáº¿t</Button>
                        </CardActions>
                    </>
                )}
            </Card>
        );
    };

    if (loading) {
        return (
            <Box sx={{ p: { xs: 2, sm: 4 }, bgcolor: "grey.50" }}>
                <Skeleton width={320} height={40} sx={{ mb: 4 }} />
                <Grid container spacing={2}>
                    {[...Array(3)].map((_, i) => (
                        <Grid key={i} size={{ xs: 12, sm: 4 }}>
                            <StatCardSkeleton />
                        </Grid>
                    ))}
                    {[...Array(6)].map((_, i) => (
                        <Grid key={i} size={{ xs: 12, md: 6, lg: 4 }}>
                            <TransferSkeleton />
                        </Grid>
                    ))}
                </Grid>
            </Box>
        );
    }

    // âœ… Cáº£i thiá»‡n: Hiá»ƒn thá»‹ error state náº¿u cĂ³ lá»—i
    if (error) {
        return (
            <Box sx={{ p: { xs: 2, sm: 4 }, bgcolor: "grey.50", minHeight: "100vh" }}>
                <ErrorState
                    error={error}
                    title="Lá»—i táº£i dá»¯ liá»‡u"
                    onRetry={() => {
                        setError(null);
                        setLoading(true);
                        // Retry logic sáº½ Ä‘Æ°á»£c xá»­ lĂ½ bá»Ÿi useEffect listeners
                    }}
                    retryLabel="Thá»­ láº¡i"
                />
            </Box>
        );
    }

    return (
        <Box sx={{
            p: { xs: 1.5, sm: 3, md: 4 },
            bgcolor: theme.palette.mode === 'light' ? "#f8fafc" : theme.palette.background.default,
            minHeight: "100vh",
            position: 'relative',
            '&::before': {
                content: '""',
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                height: '300px',
                background: theme.palette.mode === 'light'
                    ? `radial-gradient(ellipse 80% 50% at 50% 0%, ${alpha(theme.palette.primary.main, 0.08)} 0%, transparent 50%)`
                    : `radial-gradient(ellipse 80% 50% at 50% 0%, ${alpha(theme.palette.primary.main, 0.12)} 0%, transparent 50%)`,
                pointerEvents: 'none',
                zIndex: 0,
            },
        }}>
            {/* Header vá»›i Glassmorphism */}
            <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.4 }}
                style={{ position: 'relative', zIndex: 1 }}
            >
                <Paper
                    elevation={0}
                    sx={{
                        p: { xs: 2, sm: 3 },
                        mb: 3,
                        borderRadius: 3,
                        background: theme.palette.mode === 'light'
                            ? `linear-gradient(135deg, ${alpha('#ffffff', 0.9)} 0%, ${alpha('#f8fafc', 0.9)} 100%)`
                            : `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.9)} 0%, ${alpha(theme.palette.background.default, 0.9)} 100%)`,
                        backdropFilter: "blur(20px) saturate(180%)",
                        WebkitBackdropFilter: "blur(20px) saturate(180%)",
                        border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                        boxShadow: theme.palette.mode === 'light'
                            ? "0 4px 20px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.02)"
                            : "0 4px 20px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05)",
                    }}
                >
                    <Stack
                        direction={{ xs: 'column', sm: 'row' }}
                        justifyContent="space-between"
                        alignItems={{ xs: 'flex-start', sm: 'center' }}
                        spacing={2}
                    >
                        <Box sx={{ flex: 1 }}>
                            <Typography
                                variant={isMobile ? "h5" : "h4"}
                                sx={{
                                    fontWeight: 800,
                                    mb: 0.5,
                                    background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
                                    backgroundClip: 'text',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                }}
                            >
                                Quáº£n lĂ½ TĂ i sáº£n
                            </Typography>
                            <Typography
                                variant="body2"
                                color="text.secondary"
                                sx={{ fontSize: { xs: '0.875rem', sm: '1rem' } }}
                            >
                                Theo dĂµi, luĂ¢n chuyá»ƒn vĂ  quáº£n lĂ½ cĂ¡c yĂªu cáº§u thay Ä‘á»•i tĂ i sáº£n.
                            </Typography>
                        </Box>
                        {/* NĂºt hĂ nh Ä‘á»™ng chĂ­nh thay Ä‘á»•i theo Tab */}
                        {tabIndex === 1 && (
                            <motion.div
                                whileHover={{ scale: 1.02 }}
                                whileTap={{ scale: 0.98 }}
                            >
                                <Button
                                    variant="contained"
                                    size={isMobile ? "medium" : "large"}
                                    startIcon={<ArrowRightLeft />}
                                    onClick={handleOpenTransferModal}
                                    sx={{
                                        borderRadius: 2,
                                        textTransform: 'none',
                                        fontWeight: 600,
                                        px: { xs: 2, sm: 3 },
                                        boxShadow: `0 4px 12px ${alpha(theme.palette.primary.main, 0.3)}`,
                                        '&:hover': {
                                            boxShadow: `0 6px 16px ${alpha(theme.palette.primary.main, 0.4)}`,
                                        },
                                    }}
                                >
                                    {isMobile ? "Táº¡o Phiáº¿u" : "Táº¡o Phiáº¿u LuĂ¢n Chuyá»ƒn"}
                                </Button>
                            </motion.div>
                        )}
                        {tabIndex === 2 && (
                            canManageAssets && (
                                <Stack direction={{ xs: 'column', sm: 'row' }} spacing={1} sx={{ width: { xs: '100%', sm: 'auto' } }}>
                                    <Tooltip title={filterDeptsForAsset.length !== 1 ? "Vui lĂ²ng chá»n CHá»ˆ Má»˜T phĂ²ng ban Ä‘á»ƒ nháº­p tĂ i sáº£n" : "Nháº­p Excel cho phĂ²ng ban Ä‘Ă£ chá»n"}>
                                        <span>
                                            <Button
                                                variant="outlined"
                                                size={isMobile ? "medium" : "large"}
                                                onClick={() => setIsPasteModalOpen(true)}
                                                disabled={filterDeptsForAsset.length !== 1}
                                                sx={{
                                                    borderRadius: 2,
                                                    textTransform: 'none',
                                                    fontWeight: 600,
                                                    width: { xs: '100%', sm: 'auto' },
                                                }}
                                            >
                                                {isMobile ? "Excel" : "Nháº­p Excel"}
                                            </Button>
                                        </span>
                                    </Tooltip>
                                    <motion.div
                                        whileHover={{ scale: 1.02 }}
                                        whileTap={{ scale: 0.98 }}
                                        style={{ width: isMobile ? '100%' : 'auto' }}
                                    >
                                        <Button
                                            variant="contained"
                                            size={isMobile ? "medium" : "large"}
                                            startIcon={<PlusCircle />}
                                            onClick={handleOpenAddModal}
                                            fullWidth={isMobile}
                                            sx={{
                                                borderRadius: 2,
                                                textTransform: 'none',
                                                fontWeight: 600,
                                                boxShadow: `0 4px 12px ${alpha(theme.palette.primary.main, 0.3)}`,
                                                '&:hover': {
                                                    boxShadow: `0 6px 16px ${alpha(theme.palette.primary.main, 0.4)}`,
                                                },
                                            }}
                                        >
                                            {isMobile ? "ThĂªm TĂ i Sáº£n" : "ThĂªm TĂ i Sáº£n"}
                                        </Button>
                                    </motion.div>
                                </Stack>
                            )
                        )}
                    </Stack>
                </Paper>
            </motion.div>

            {/* Stats Cards vá»›i Animations */}
            <Grid container spacing={{ xs: 1.5, sm: 2 }} sx={{ mb: 3, position: 'relative', zIndex: 1 }}>
                {stats.map((stat, index) => (
                    <Grid size={{ xs: 6, sm: 6, md: 4 }} key={stat.label}>
                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ duration: 0.4, delay: index * 0.1 }}
                            whileHover={{ y: -4 }}
                        >
                            <Paper
                                variant="outlined"
                                onClick={stat.onClick}
                                sx={{
                                    p: { xs: 2, sm: 2.5 },
                                    borderRadius: 3,
                                    background: theme.palette.mode === 'light'
                                        ? `linear-gradient(135deg, ${alpha(theme.palette[stat.color].main, 0.08)} 0%, ${alpha(theme.palette[stat.color].main, 0.03)} 100%)`
                                        : `linear-gradient(135deg, ${alpha(theme.palette[stat.color].main, 0.15)} 0%, ${alpha(theme.palette[stat.color].main, 0.08)} 100%)`,
                                    border: `1px solid ${alpha(theme.palette[stat.color].main, 0.2)}`,
                                    cursor: stat.onClick ? 'pointer' : 'default',
                                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                    position: 'relative',
                                    overflow: 'hidden',
                                    '&::before': {
                                        content: '""',
                                        position: 'absolute',
                                        top: 0,
                                        left: 0,
                                        right: 0,
                                        height: '3px',
                                        background: `linear-gradient(90deg, ${theme.palette[stat.color].main} 0%, ${theme.palette[stat.color].light} 100%)`,
                                    },
                                    '&:hover': {
                                        transform: stat.onClick ? 'translateY(-4px)' : 'none',
                                        boxShadow: stat.onClick
                                            ? `0 8px 24px ${alpha(theme.palette[stat.color].main, 0.2)}`
                                            : 'none',
                                        borderColor: alpha(theme.palette[stat.color].main, 0.4),
                                    }
                                }}
                            >
                                <Stack direction="row" spacing={2} alignItems="center">
                                    <Avatar
                                        sx={{
                                            bgcolor: `${stat.color}.light`,
                                            color: `${stat.color}.dark`,
                                            width: { xs: 48, sm: 56 },
                                            height: { xs: 48, sm: 56 },
                                            boxShadow: `0 4px 12px ${alpha(theme.palette[stat.color].main, 0.2)}`,
                                        }}
                                    >
                                        {stat.icon}
                                    </Avatar>
                                    <Box sx={{ flex: 1, minWidth: 0 }}>
                                        <Typography
                                            variant={isMobile ? "h6" : "h5"}
                                            sx={{
                                                fontWeight: 700,
                                                fontSize: { xs: '1.25rem', sm: '1.5rem' },
                                            }}
                                        >
                                            {stat.value}
                                        </Typography>
                                        <Typography
                                            variant="body2"
                                            color="text.secondary"
                                            sx={{
                                                fontSize: { xs: '0.75rem', sm: '0.875rem' },
                                                mt: 0.25,
                                            }}
                                        >
                                            {stat.label}
                                        </Typography>
                                    </Box>
                                </Stack>
                            </Paper>
                        </motion.div>
                    </Grid>
                ))}
            </Grid>

            {/* Tabs vá»›i Modern Design */}
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.4, delay: 0.2 }}
                style={{ position: 'relative', zIndex: 1 }}
            >
                <Paper
                    elevation={0}
                    sx={{
                        border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                        borderRadius: 3,
                        overflow: "hidden",
                        background: theme.palette.mode === 'light'
                            ? `linear-gradient(135deg, ${alpha('#ffffff', 0.95)} 0%, ${alpha('#f8fafc', 0.95)} 100%)`
                            : `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.95)} 0%, ${alpha(theme.palette.background.default, 0.95)} 100%)`,
                        backdropFilter: "blur(20px) saturate(180%)",
                        WebkitBackdropFilter: "blur(20px) saturate(180%)",
                        boxShadow: theme.palette.mode === 'light'
                            ? "0 4px 20px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.02)"
                            : "0 4px 20px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05)",
                    }}
                >
                    <Tabs
                        value={tabIndex}
                        onChange={(e, v) => setTabIndex(v)}
                        sx={{
                            borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                            minHeight: { xs: 56, sm: 64 },
                            '& .MuiTab-root': {
                                minHeight: { xs: 56, sm: 64 },
                                minWidth: { xs: 80, sm: 'auto' },
                                padding: { xs: '12px 16px', sm: '16px 24px' },
                                textTransform: 'none',
                                fontWeight: 600,
                                fontSize: { xs: '0.875rem', sm: '0.9375rem' },
                                transition: 'all 0.2s ease',
                                '&.Mui-selected': {
                                    color: 'primary.main',
                                },
                            },
                            '& .MuiTabs-indicator': {
                                height: 3,
                                borderRadius: '3px 3px 0 0',
                                background: `linear-gradient(90deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
                            },
                        }}
                        variant="scrollable"
                        scrollButtons="auto"
                        allowScrollButtonsMobile
                    >
                        {/* TAB 0: Dashboard (Giá»¯ nguyĂªn logic Badge cÅ© cá»§a báº¡n) */}
                        <Tab
                            label={
                                <Badge badgeContent={actionableItems.total} color="primary" max={99}>
                                    <Typography sx={{ display: { xs: 'none', sm: 'block' } }}>Dashboard</Typography>
                                </Badge>
                            }
                            icon={<Inbox size={18} />}
                            iconPosition="start"
                        />

                        {/* TAB 1: Theo dĂµi LuĂ¢n chuyá»ƒn */}
                        <Tab
                            icon={<Send size={18} />}
                            iconPosition="start"
                            label={<Typography sx={{ display: { xs: 'none', sm: 'block' } }}>Theo dĂµi LuĂ¢n chuyá»ƒn</Typography>}
                            // ThĂªm Tooltip cho mobile (chá»‰ hiá»‡n icon)
                            title="Theo dĂµi LuĂ¢n chuyá»ƒn"
                        />

                        {/* TAB 2: Danh sĂ¡ch TĂ i sáº£n */}
                        <Tab
                            icon={<Warehouse size={18} />}
                            iconPosition="start"
                            label={<Typography sx={{ display: { xs: 'none', sm: 'block' } }}>Danh sĂ¡ch TĂ i sáº£n</Typography>}
                            title="Danh sĂ¡ch TĂ i sáº£n"
                        />

                        {/* TAB 3: YĂªu cáº§u Thay Ä‘á»•i */}
                        <Tab
                            icon={<History size={18} />}
                            iconPosition="start"
                            label={<Typography sx={{ display: { xs: 'none', sm: 'block' } }}>YĂªu cáº§u Thay Ä‘á»•i</Typography>}
                            title="YĂªu cáº§u Thay Ä‘á»•i"
                        />

                        {/* TAB 4: BĂ¡o cĂ¡o Kiá»ƒm kĂª */}
                        <Tab
                            icon={<BookCheck size={18} />}
                            iconPosition="start"
                            label={<Typography sx={{ display: { xs: 'none', sm: 'block' } }}>BĂ¡o cĂ¡o Kiá»ƒm kĂª</Typography>}
                            title="BĂ¡o cĂ¡o Kiá»ƒm kĂª"
                        />
                    </Tabs>
                    {tabIndex === 0 && (
                        <DashboardTab
                            actionableItems={actionableItems}
                            isMobile={isMobile}
                            signing={signing}
                            processingReport={processingReport}
                            onTransferClick={handleOpenDetailView}
                            onRequestClick={handleOpenRequestDetail}
                            onReportClick={handleOpenReportDetail}
                            onSignTransfer={handleSign}
                            onProcessRequest={handleProcessRequest}
                            onSignReport={handleSignReport}
                            onRejectRequest={(item) => setRejectConfirm(item)}
                            onRejectReport={(item) => setRejectReportConfirm(item)}
                            currentUser={currentUser}
                            canSignSender={canSignSender}
                            canSignReceiver={canSignReceiver}
                            canSignAdmin={canSignAdmin}
                            isMyTurn={isMyTurn}
                            canProcessRequest={canProcessRequest}
                            canProcessReport={canProcessReport}
                        />
                    )}


{
    tabIndex === 1 && (
        <Box sx={{ p: { xs: 1.5, sm: 2.5 }, bgcolor: 'transparent' }}>
            {/* Thanh cĂ´ng cá»¥ vá»›i Bá»™ lá»c - Modern Design */}
            <Paper
                variant="outlined"
                sx={{
                    p: { xs: 1.5, sm: 2 },
                    mb: 2.5,
                    borderRadius: 2.5,
                    background: theme.palette.mode === 'light'
                        ? `linear-gradient(135deg, ${alpha('#ffffff', 0.8)} 0%, ${alpha('#f8fafc', 0.8)} 100%)`
                        : `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.8)} 0%, ${alpha(theme.palette.background.default, 0.8)} 100%)`,
                    backdropFilter: "blur(10px)",
                    border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,
                    boxShadow: theme.palette.mode === 'light'
                        ? "0 2px 8px rgba(0,0,0,0.04)"
                        : "0 2px 8px rgba(0,0,0,0.2)",
                }}
            >
                <Stack
                    direction={{ xs: 'column', sm: 'row' }}
                    spacing={1.5}
                    alignItems={{ xs: 'stretch', sm: 'center' }}
                >
                    <Tooltip title="Nháº¥n Ctrl+K (hoáº·c Cmd+K) Ä‘á»ƒ tĂ¬m kiáº¿m nhanh" placement="top">
                        <TextField
                            placeholder={isMobile ? "đŸ” TĂ¬m kiáº¿m..." : "đŸ” TĂ¬m mĂ£ phiáº¿u, phĂ²ng ban..."}
                            size="small"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            sx={{
                                flex: { xs: '1 1 auto', sm: "1 1 360px" },
                                '& .MuiOutlinedInput-root': {
                                    borderRadius: 2,
                                    bgcolor: theme.palette.mode === 'light' ? 'white' : alpha(theme.palette.background.paper, 0.5),
                                },
                            }}
                        />
                    </Tooltip>
                    <Button
                        variant="outlined"
                        size={isMobile ? "medium" : "small"}
                        startIcon={<Filter />}
                        onClick={() => setDrawerOpen(true)}
                        sx={{
                            borderRadius: 2,
                            textTransform: 'none',
                            fontWeight: 600,
                            minWidth: { xs: '100%', sm: 'auto' },
                            borderColor: alpha(theme.palette.primary.main, 0.3),
                            '&:hover': {
                                borderColor: theme.palette.primary.main,
                                bgcolor: alpha(theme.palette.primary.main, 0.08),
                            },
                        }}
                    >
                        {isMobile ? "Lá»c" : "Bá»™ lá»c"}
                        {(statusMulti.length > 0 || fromDeptIds.length > 0 || toDeptIds.length > 0 || createdByDeb.trim()) && (
                            <Badge
                                badgeContent={statusMulti.length + fromDeptIds.length + toDeptIds.length + (createdByDeb.trim() ? 1 : 0)}
                                color="primary"
                                sx={{ ml: 1, '& .MuiBadge-badge': { right: -8, top: -8, fontWeight: 700 } }}
                            />
                        )}
                    </Button>
                </Stack>
            </Paper>

            {/* --- Khu vá»±c hiá»ƒn thá»‹ ná»™i dung Ä‘á»™ng --- */}

            {/* Cháº¿ Ä‘á»™ xem tháº» (Card View) - GIAO DIá»†N Má»I */}

            {/* Cháº¿ Ä‘á»™ xem báº£ng (Table View) - GIAO DIá»†N Má»I HIá»†N Äáº I */}
            {(
                isMobile ? (
                    // Giao diá»‡n cho mobile: Danh sĂ¡ch cĂ¡c Card
                    <Box mt={2.5}>
                        {filteredTransfers.map((t) => (
                            <TransferTableRowMobile
                                key={t.id}
                                transfer={t}
                                onDetailClick={handleOpenDetailView}
                                isMyTurn={isMyTurn(t)}
                                actionButtons={<TransferActionButtons transfer={t} />}
                            />
                        ))}
                    </Box>
                ) : (
                    // âœ… THAY THáº¾ KHá»I <TableContainer> Cá»¦A tabIndex === 1 Báº°NG CODE NĂ€Y

                    <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2, overflow: 'hidden' }}>
                        <Table sx={{ minWidth: 650, '& .MuiTableCell-root': { borderBottom: '1px solid', borderColor: 'divider' } }} aria-label="transfer table">
                            <TableHead sx={{ bgcolor: 'grey.50' }}>
                                <TableRow>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>MĂ£ Phiáº¿u</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>Lá»™ trĂ¬nh</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>NgÆ°á»i táº¡o & NgĂ y táº¡o</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>Tráº¡ng thĂ¡i</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary', width: '180px' }} align="right">HĂ nh Ä‘á»™ng</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {filteredTransfers.map((t) => (
                                    <TableRow
                                        key={t.id}
                                        hover
                                        sx={{
                                            cursor: 'pointer',
                                            // Táº¡o hiá»‡u á»©ng "card"
                                            '&:last-child td, &:last-child th': { border: 0 },
                                            '&:hover': {
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                                                transform: 'translateY(-1px)',
                                            },
                                            transition: 'all 0.15s ease-in-out',
                                            bgcolor: 'background.paper'
                                        }}
                                        onClick={() => handleOpenDetailView(t)}
                                    >
                                        <TableCell component="th" scope="row">
                                            <Badge color="primary" variant="dot" invisible={!isMyTurn(t)}>
                                                <Chip size="small" label={t.maPhieuHienThi || `#${shortId(t.id)}`} sx={{ fontWeight: 600, bgcolor: 'grey.100' }} />
                                            </Badge>
                                        </TableCell>
                                        <TableCell>
                                            <Stack>
                                                <Typography variant="body2" sx={{ fontWeight: 500, display: 'flex', alignItems: 'center', gap: 1 }}>
                                                    <Avatar sx={{ width: 24, height: 24, bgcolor: 'action.hover', color: 'text.secondary' }}><Send size={14} /></Avatar>
                                                    {hi(t.from, debSearch)}
                                                </Typography>
                                                <Typography variant="body2" sx={{ fontWeight: 700, color: 'primary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                                                    <Avatar sx={{ width: 24, height: 24, bgcolor: 'transparent' }}><ArrowRight size={14} /></Avatar>
                                                    {hi(t.to, debSearch)}
                                                </Typography>
                                            </Stack>
                                        </TableCell>
                                        <TableCell>
                                            <Stack direction="row" spacing={1.5} alignItems="center">
                                                <Avatar sx={{ width: 32, height: 32, bgcolor: 'primary.lighter', color: 'primary.main', fontSize: '0.9rem' }}>
                                                    {t.createdBy?.name?.charAt(0)?.toUpperCase() || 'B'}
                                                </Avatar>
                                                <Box>
                                                    <Typography variant="body2" sx={{ fontWeight: 600 }}>{t.createdBy?.name}</Typography>
                                                    <Typography variant="caption" color="text.secondary">{fullTime(t.date)}</Typography>
                                                </Box>
                                            </Stack>
                                        </TableCell>
                                        <TableCell>
                                            <Chip
                                                size="small"
                                                label={statusConfig[t.status]?.label}
                                                color={statusConfig[t.status]?.color || "default"}
                                                icon={statusConfig[t.status]?.icon}
                                                variant="outlined"
                                            />
                                        </TableCell>
                                        <TableCell align="right" onClick={(e) => e.stopPropagation()}>
                                            <Stack direction="row" spacing={0.5} justifyContent="flex-end" alignItems="center">
                                                {t.status !== 'COMPLETED' ? (
                                                    <TransferActionButtons transfer={t} />
                                                ) : (
                                                    <Button size="small" variant="outlined" onClick={() => handleOpenDetailView(t)} sx={{ whiteSpace: 'nowrap' }}>
                                                        Chi tiáº¿t
                                                    </Button>
                                                )}
                                                {canDeleteTransfer(t) && (
                                                    <Tooltip title="XĂ³a phiáº¿u">
                                                        <IconButton size="small" sx={{ color: 'error.main' }} onClick={(e) => { e.stopPropagation(); deleteTransfer(t); }}>
                                                            <Trash2 size={18} />
                                                        </IconButton>
                                                    </Tooltip>
                                                )}
                                            </Stack>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </TableContainer>
                )
            )}
            {/* âœ… Cáº£i thiá»‡n: Sá»­ dá»¥ng EmptyState component */}
            {filteredTransfers.length === 0 && (
                <EmptyState
                    icon={<Inbox size={64} />}
                    title="KhĂ´ng cĂ³ phiáº¿u nĂ o phĂ¹ há»£p"
                    description={
                        (statusMulti.length > 0 || fromDeptIds.length > 0 || toDeptIds.length > 0 || debSearch.trim())
                            ? "Thá»­ Ä‘iá»u chá»‰nh bá»™ lá»c Ä‘á»ƒ xem thĂªm káº¿t quáº£."
                            : "ChÆ°a cĂ³ phiáº¿u luĂ¢n chuyá»ƒn nĂ o. Táº¡o phiáº¿u má»›i Ä‘á»ƒ báº¯t Ä‘áº§u."
                    }
                    actionLabel={statusMulti.length === 0 && fromDeptIds.length === 0 && toDeptIds.length === 0 && !debSearch.trim() ? "Táº¡o Phiáº¿u Má»›i" : undefined}
                    onAction={statusMulti.length === 0 && fromDeptIds.length === 0 && toDeptIds.length === 0 && !debSearch.trim() ? handleOpenTransferModal : undefined}
                />
            )}
        </Box>
    )
}

{
    tabIndex === 2 && (
        <Box sx={{ p: { xs: 1.5, sm: 2.5 } }}>
            {/* Toolbar chá»©a bá»™ lá»c vĂ  cĂ¡c nĂºt hĂ nh Ä‘á»™ng (giá»¯ nguyĂªn) */}
            <Paper variant="outlined" sx={{ p: 1.5, mb: 2, borderRadius: 2 }}>
                <Toolbar disableGutters sx={{ gap: 1, flexWrap: "wrap" }}>
                    <Tooltip title="Nháº¥n Ctrl+K (hoáº·c Cmd+K) Ä‘á»ƒ tĂ¬m kiáº¿m nhanh" placement="top">
                        <TextField
                            placeholder="đŸ” TĂ¬m theo tĂªn tĂ i sáº£n..."
                            size="small"
                            sx={{ flex: "1 1 320px" }}
                            value={assetSearch}
                            onChange={(e) => setAssetSearch(e.target.value)}
                        />
                    </Tooltip>
                    <FormControl size="small" sx={{ minWidth: 220, maxWidth: 300 }}>
                        <InputLabel>Lá»c theo phĂ²ng ban</InputLabel>
                        <Select
                            multiple
                            value={filterDeptsForAsset}
                            onChange={(e) => {
                                const value = e.target.value;
                                setFilterDeptsForAsset(typeof value === 'string' ? value.split(',') : value);
                            }}
                            input={<OutlinedInput label="Lá»c theo phĂ²ng ban" />}
                            renderValue={(selectedIds) => (
                                selectedIds.map(id => departments.find(d => d.id === id)?.name || id).join(', ')
                            )}
                            MenuProps={{ PaperProps: { sx: { maxHeight: 280 } } }}
                        >
                            {departments.map((d) => (
                                <MenuItem key={d.id} value={d.id}>
                                    <Checkbox checked={filterDeptsForAsset.indexOf(d.id) > -1} />
                                    <ListItemText primary={d.name} />
                                </MenuItem>
                            ))}
                        </Select>
                    </FormControl>
                    <Box flexGrow={1} />
                    {canManageAssets && (
                        <Stack direction="row" spacing={1} flexWrap="wrap">
                            <Button
                                variant="outlined"
                                color="secondary"
                                startIcon={<QrCode />}
                                onClick={() => setIsLabelPrintModalOpen(true)}
                                disabled={selectedAssetIdsForPrint.length === 0}
                            >
                                In Tem ({selectedAssetIdsForPrint.length})
                            </Button>

                            {/* âœ… ÄĂ‚Y LĂ€ NĂT Má»I ÄÆ¯á»¢C THĂM VĂ€O */}
                            <Button
                                variant="outlined"
                                color="info"
                                startIcon={<Calendar size={16} />}
                                onClick={() => {
                                    setNewCheckDate(new Date()); // Gá»£i Ă½ ngĂ y hĂ´m nay
                                    setIsUpdateDateModalOpen(true);
                                }}
                                disabled={selectedAssetIdsForPrint.length === 0}
                            >
                                Cáº­p nháº­t NgĂ y ({selectedAssetIdsForPrint.length})
                            </Button>

                            <Button variant="contained" startIcon={<Printer />} onClick={() => setIsPrintModalOpen(true)}>
                                In BĂ¡o cĂ¡o
                            </Button>
                        </Stack>
                    )}
                </Toolbar>
            </Paper>

            {/* âœ… Báº®T Äáº¦U LOGIC HIá»‚N THá» Äá»˜NG (ÄĂƒ Sá»¬A) */}
            {isMobile ? (
                // Giao diá»‡n cho Ä‘iá»‡n thoáº¡i: Danh sĂ¡ch cĂ¡c Card (ÄĂƒ Sá»¬A)
                <Box>
                    {/* Checkbox chá»n táº¥t cáº£ */}
                    {canManageAssets && (
                        <FormControlLabel
                            control={
                                <Checkbox
                                    color="primary"
                                    indeterminate={selectedAssetIdsForPrint.length > 0 && selectedAssetIdsForPrint.length < filteredAssets.length}
                                    checked={filteredAssets.length > 0 && selectedAssetIdsForPrint.length === filteredAssets.length}
                                    onChange={handleSelectAllAssets}
                                />
                            }
                            label="Chá»n táº¥t cáº£ Ä‘á»ƒ in tem"
                            sx={{ mb: 1, color: 'text.secondary' }}
                        />
                    )}

                    {groupedAssets.map((group) => (
                        <React.Fragment key={group.name}>
                            {/* TĂªn phĂ²ng ban */}
                            <Typography
                                variant="overline"
                                sx={{
                                    display: 'block',
                                    fontWeight: 700,
                                    color: 'primary.main',
                                    py: 1,
                                    px: 1.5,
                                    mt: 1,
                                    bgcolor: 'primary.lighter',
                                    borderRadius: 1.5,
                                }}
                            >
                                {group.name}
                            </Typography>

                            {/* Danh sĂ¡ch tĂ i sáº£n trong phĂ²ng ban (CHá»ˆ GIá»® Láº I VĂ’NG Láº¶P ÄĂNG) */}
                            {group.items.map((a) => {
                                const isSelected = selectedAssetIdsForPrint.indexOf(a.id) !== -1;
                                return (
                                    <AssetCardMobile
                                        key={a.id}
                                        asset={a}
                                        isSelected={isSelected}
                                        canManageAssets={canManageAssets}
                                        onSelect={handleSelectAssetForPrint}
                                        onEdit={() => handleMemoizedAssetEdit(a)}
                                        onDelete={() => handleMemoizedAssetDelete(a)}
                                    />
                                );
                            })}
                        </React.Fragment>
                    ))}
                </Box>
            ) : (
                // Giao diá»‡n cho Desktop: Báº£ng dá»¯ liá»‡u (âœ… ÄĂƒ Tá»I Æ¯U HĂ“A)
                <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2 }}>
                    <Table stickyHeader>
                        <TableHead>
                            <TableRow>
                                {canManageAssets && (
                                    <TableCell padding="checkbox">
                                        <Checkbox
                                            color="primary"
                                            indeterminate={selectedAssetIdsForPrint.length > 0 && selectedAssetIdsForPrint.length < filteredAssets.length}
                                            checked={filteredAssets.length > 0 && selectedAssetIdsForPrint.length === filteredAssets.length}
                                            onChange={handleSelectAllAssets}
                                            inputProps={{ 'aria-label': 'chá»n táº¥t cáº£ tĂ i sáº£n' }}
                                        />
                                    </TableCell>
                                )}
                                <TableCell sx={{ fontWeight: "bold" }}>TĂªn tĂ i sáº£n</TableCell>
                                <TableCell sx={{ fontWeight: "bold" }}>KĂ­ch thÆ°á»›c</TableCell>
                                <TableCell sx={{ fontWeight: "bold" }} align="center">Sá»‘ lÆ°á»£ng</TableCell>
                                <TableCell sx={{ fontWeight: "bold" }}>ÄVT</TableCell>
                                <TableCell sx={{ fontWeight: "bold" }}>Ghi chĂº</TableCell>
                                <TableCell sx={{ fontWeight: "bold" }}>NgĂ y kiá»ƒm kĂª</TableCell>
                                {canManageAssets && (
                                    <TableCell sx={{ fontWeight: "bold" }} align="right">Thao tĂ¡c</TableCell>
                                )}
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {groupedAssets.map((group) => (
                                <React.Fragment key={group.name}>
                                    <TableRow>
                                        <TableCell colSpan={canManageAssets ? 8 : 6}
                                            sx={{
                                                position: 'sticky', top: 56, zIndex: 1,
                                                backgroundColor: 'grey.100', fontWeight: 800,
                                                textTransform: 'uppercase', letterSpacing: '0.5px',
                                                color: 'primary.main', borderBottom: '2px solid',
                                                borderColor: 'grey.300'
                                            }}
                                        >
                                            PHĂ’NG BAN: {group.name}
                                        </TableCell>
                                    </TableRow>

                                    {/* âœ… Sá»¬ Dá»¤NG COMPONENT AssetTableRow TĂI Sá»¬ Dá»¤NG */}
                                    {group.items.map((a) => {
                                        const isSelected = selectedAssetIdsForPrint.indexOf(a.id) !== -1;
                                        return (
                                            <AssetTableRow
                                                key={a.id}
                                                asset={a}
                                                isSelected={isSelected}
                                                canManageAssets={canManageAssets}
                                                assetSearch={assetSearch}
                                                // âœ… Sá»¬ Dá»¤NG CĂC HĂ€M ÄĂƒ Bá»ŒC
                                                onSelect={handleSelectAssetForPrint}
                                                onEdit={handleMemoizedAssetEdit}
                                                onDelete={handleMemoizedAssetDelete}
                                            />
                                        );
                                    })}
                                </React.Fragment>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            )}

            {/* âœ… Cáº£i thiá»‡n: Sá»­ dá»¥ng EmptyState component */}
            {filteredAssets.length === 0 && (
                <EmptyState
                    icon={<Warehouse size={64} />}
                    title="KhĂ´ng cĂ³ tĂ i sáº£n nĂ o phĂ¹ há»£p"
                    description={
                        (assetSearch.trim() || filterDeptsForAsset.length > 0)
                            ? "Thá»­ Ä‘iá»u chá»‰nh bá»™ lá»c hoáº·c tá»« khĂ³a tĂ¬m kiáº¿m Ä‘á»ƒ xem thĂªm káº¿t quáº£."
                            : "ChÆ°a cĂ³ tĂ i sáº£n nĂ o trong há»‡ thá»‘ng. ThĂªm tĂ i sáº£n má»›i Ä‘á»ƒ báº¯t Ä‘áº§u quáº£n lĂ½."
                    }
                    actionLabel={(assetSearch.trim() || filterDeptsForAsset.length > 0) ? undefined : (canManageAssets ? "ThĂªm TĂ i Sáº£n" : undefined)}
                    onAction={(assetSearch.trim() || filterDeptsForAsset.length > 0) ? undefined : (canManageAssets ? handleOpenAddModal : undefined)}
                />
            )}

            {/* âœ… THĂM NĂT Táº¢I THĂM NĂ€Y VĂ€O */}
            {filteredAssets.length > visibleAssetCount && (
                <Box sx={{ textAlign: 'center', p: 3 }}>
                    <Button
                        variant="outlined"
                        onClick={() => setVisibleAssetCount(prevCount => prevCount + 100)} // Táº£i thĂªm 100
                        size="large"
                    >
                        Táº£i thĂªm {Math.min(100, filteredAssets.length - visibleAssetCount)} tĂ i sáº£n
                        ({visibleAssetCount} / {filteredAssets.length})
                    </Button>
                </Box>
            )}
        </Box>
    )
}
{
    tabIndex === 3 && (
        <Box sx={{ p: { xs: 1.5, sm: 2.5 }, bgcolor: '#fbfcfe' }}>
            {/* Thanh cĂ´ng cá»¥ vá»›i Bá»™ lá»c vĂ  NĂºt chuyá»ƒn Ä‘á»•i View */}
            <Paper variant="outlined" sx={{ p: 1.5, mb: 2.5, borderRadius: 2 }}>
                <Toolbar disableGutters sx={{ gap: 1, flexWrap: "wrap" }}>
                    <Tooltip title="Nháº¥n Ctrl+K (hoáº·c Cmd+K) Ä‘á»ƒ tĂ¬m kiáº¿m nhanh" placement="top">
                        <TextField
                            placeholder="đŸ” TĂ¬m tĂªn tĂ i sáº£n, ngÆ°á»i yĂªu cáº§u..."
                            size="small"
                            sx={{ flex: "1 1 360px" }}
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                        />
                    </Tooltip>
                </Toolbar>
            </Paper>

            {/* --- Khu vá»±c hiá»ƒn thá»‹ ná»™i dung Ä‘á»™ng (ÄĂ£ Ä‘Æ°á»£c cáº¥u trĂºc láº¡i) --- */}
            {loading ? (
                // 1. Tráº¡ng thĂ¡i Ä‘ang táº£i
                <Grid container spacing={2.5}>
                    {[...Array(6)].map((_, i) => (
                        <Grid size={{ xs: 12, md: 6, lg: 4 }} key={i}>
                            <RequestCardSkeleton />
                        </Grid>
                    ))}
                </Grid>
            ) : filteredRequests.length === 0 ? (
                // âœ… Cáº£i thiá»‡n: Sá»­ dá»¥ng EmptyState component
                <EmptyState
                    icon={<History size={64} />}
                    title="KhĂ´ng cĂ³ yĂªu cáº§u nĂ o"
                    description={
                        search.trim()
                            ? "KhĂ´ng tĂ¬m tháº¥y yĂªu cáº§u nĂ o phĂ¹ há»£p vá»›i tá»« khĂ³a tĂ¬m kiáº¿m. Thá»­ tá»« khĂ³a khĂ¡c hoáº·c xĂ³a bá»™ lá»c."
                            : "ChÆ°a cĂ³ yĂªu cáº§u thay Ä‘á»•i tĂ i sáº£n nĂ o. YĂªu cáº§u sáº½ xuáº¥t hiá»‡n á»Ÿ Ä‘Ă¢y khi Ä‘Æ°á»£c táº¡o."
                    }
                />
            ) : (
                // 3. Hiá»ƒn thá»‹ dá»¯ liá»‡u (LOGIC ÄĂNG)
                isMobile ? (
                    // Giao diá»‡n cho mobile: Danh sĂ¡ch cĂ¡c Card tĂ³m táº¯t
                    <Box mt={2.5} sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                        {filteredRequests.map((req) => (
                            <RequestTableRowMobile
                                key={req.id}
                                request={req}
                            />
                        ))}
                    </Box>
                ) : (
                    // Giao diá»‡n cho desktop: Báº£ng Ä‘áº§y Ä‘á»§
                    // âœ… THAY THáº¾ KHá»I <TableContainer> Cá»¦A tabIndex === 3 Báº°NG CODE NĂ€Y

                    <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2, overflow: 'hidden' }}>
                        <Table sx={{ minWidth: 650, '& .MuiTableCell-root': { borderBottom: '1px solid', borderColor: 'divider' } }} aria-label="danh sĂ¡ch yĂªu cáº§u">
                            <TableHead sx={{ bgcolor: 'grey.50' }}>
                                <TableRow>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>MĂ£ phiáº¿u</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>TĂ i sáº£n & Loáº¡i Y/C</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>PhĂ²ng ban</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>NgÆ°á»i Y/C</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>Tráº¡ng thĂ¡i</TableCell>
                                    <TableCell sx={{ fontWeight: 700, color: 'text.secondary', width: '210px' }} align="right">HĂ nh Ä‘á»™ng</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {filteredRequests.map((req) => (
                                    <TableRow
                                        key={req.id}
                                        hover
                                        sx={{
                                            '&:last-child td, &:last-child th': { border: 0 },
                                            cursor: 'pointer',
                                            '&:hover': {
                                                boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                                                transform: 'translateY(-1px)',
                                            },
                                            transition: 'all 0.15s ease-in-out',
                                            bgcolor: 'background.paper'
                                        }}
                                        onClick={() => handleOpenRequestDetail(req)}
                                    >
                                        <TableCell>
                                            <Chip size="small" label={req.maPhieuHienThi || `#${shortId(req.id)}`} sx={{ fontWeight: 600, bgcolor: 'grey.100' }} />
                                        </TableCell>
                                        <TableCell>
                                            <Stack direction="row" spacing={1.5} alignItems="center">
                                                <Avatar sx={{
                                                    width: 32, height: 32,
                                                    bgcolor: req.type === 'ADD' ? 'success.lighter' : (req.type === 'DELETE' ? 'error.lighter' : 'warning.lighter'),
                                                    color: req.type === 'ADD' ? 'success.dark' : (req.type === 'DELETE' ? 'error.dark' : 'warning.dark'),
                                                }}>
                                                    {req.type === 'ADD' ? <FilePlus size={16} /> : (req.type === 'DELETE' ? <FileX size={16} /> : <FilePen size={16} />)}
                                                </Avatar>
                                                <Box>
                                                    <Typography sx={{ fontWeight: 600 }}>{req.assetData?.name}</Typography>
                                                    <Typography variant="caption" color="text.secondary">
                                                        {req.type === 'ADD' ? 'Y/C ThĂªm' : (req.type === 'DELETE' ? 'Y/C XĂ³a' : `Y/C Giáº£m ${req.assetData?.quantity} SL`)}
                                                    </Typography>
                                                </Box>
                                            </Stack>
                                        </TableCell>
                                        <TableCell>{req.departmentName}</TableCell>
                                        <TableCell>
                                            <Stack direction="row" spacing={1.5} alignItems="center">
                                                <Avatar sx={{ width: 32, height: 32, bgcolor: 'secondary.lighter', color: 'secondary.main', fontSize: '0.9rem' }}>
                                                    {req.requester?.name?.charAt(0)?.toUpperCase() || 'Y'}
                                                </Avatar>
                                                <Box>
                                                    <Typography variant="body2" sx={{ fontWeight: 600 }}>{req.requester?.name}</Typography>
                                                    <Typography variant="caption" color="text.secondary">{formatTime(req.createdAt)}</Typography>
                                                </Box>
                                            </Stack>
                                        </TableCell>
                                        <TableCell>
                                            <Chip
                                                size="small"
                                                label={requestStatusConfig[req.status]?.label}
                                                color={requestStatusConfig[req.status]?.color || "default"}
                                                icon={requestStatusConfig[req.status]?.icon}
                                                variant="outlined"
                                            />
                                        </TableCell>
                                        <TableCell align="right">
                                            <Stack direction="row" spacing={0.5} justifyContent="flex-end" onClick={(e) => e.stopPropagation()}>
                                                {canProcessRequest(req) ? (
                                                    <>
                                                        <Button variant="outlined" size="small" color="error" onClick={() => setRejectConfirm(req)} disabled={isProcessingRequest[req.id]}>
                                                            {isProcessingRequest[req.id] ? "..." : "Tá»« chá»‘i"}
                                                        </Button>
                                                        <Button variant="contained" size="small" onClick={() => handleProcessRequest(req, 'approve')} disabled={isProcessingRequest[req.id]} startIcon={<Check size={16} />}>
                                                            {isProcessingRequest[req.id] ? "..." : getApprovalActionLabel(req)}
                                                        </Button>
                                                    </>
                                                ) : (
                                                    <Button size="small" variant="outlined" onClick={() => handleOpenRequestDetail(req)}>
                                                        Chi tiáº¿t
                                                    </Button>
                                                )}
                                                {currentUser?.role === 'admin' && (
                                                    <Tooltip title="XĂ³a">
                                                        <IconButton size="small" onClick={() => setDeleteRequestConfirm(req)}>
                                                            <Trash2 size={16} />
                                                        </IconButton>
                                                    </Tooltip>
                                                )}
                                            </Stack>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    </TableContainer>
                )
            )}
        </Box>
    )
}
{
    tabIndex === 4 && (
        <Box sx={{ p: { xs: 1.5, sm: 2.5 }, bgcolor: '#fbfcfe' }}>
            {/* Toolbar: TĂ¬m kiáº¿m */}
            <Paper variant="outlined" sx={{ p: 1.5, mb: 2.5, borderRadius: 2 }}>
                <Toolbar disableGutters sx={{ gap: 1, flexWrap: "wrap" }}>
                    <Tooltip title="Nháº¥n Ctrl+K (hoáº·c Cmd+K) Ä‘á»ƒ tĂ¬m kiáº¿m nhanh" placement="top">
                        <TextField
                            placeholder="đŸ” TĂ¬m mĂ£ phiáº¿u, tiĂªu Ä‘á», phĂ²ng ban, ngÆ°á»i yĂªu cáº§u..."
                            size="small"
                            sx={{ flex: "1 1 360px" }}
                            value={reportSearch}
                            onChange={(e) => setReportSearch(e.target.value)}
                        />
                    </Tooltip>
                </Toolbar>
            </Paper>

            {/* âœ… Cáº£i thiá»‡n: Sá»­ dá»¥ng EmptyState component */}
            {filteredReports.length === 0 ? (
                <EmptyState
                    icon={<BookCheck size={64} />}
                    title="KhĂ´ng cĂ³ bĂ¡o cĂ¡o nĂ o"
                    description={
                        reportSearch.trim()
                            ? "KhĂ´ng tĂ¬m tháº¥y bĂ¡o cĂ¡o nĂ o phĂ¹ há»£p vá»›i tá»« khĂ³a tĂ¬m kiáº¿m. Thá»­ tá»« khĂ³a khĂ¡c."
                            : "ChÆ°a cĂ³ bĂ¡o cĂ¡o kiá»ƒm kĂª nĂ o. Táº¡o bĂ¡o cĂ¡o má»›i Ä‘á»ƒ báº¯t Ä‘áº§u."
                    }
                    actionLabel={reportSearch.trim() ? undefined : (canManageAssets ? "Táº¡o BĂ¡o CĂ¡o" : undefined)}
                    onAction={reportSearch.trim() ? undefined : (canManageAssets ? () => setIsPrintModalOpen(true) : undefined)}
                />
            ) : isMobile ? (
                // Giao diá»‡n cho mobile
                <Box mt={2.5}>
                    {filteredReports.map((report) => (
                        <ReportTableRowMobile key={report.id} report={report} />
                    ))}
                </Box>
            ) : (
                // âœ… THAY THáº¾ KHá»I <TableContainer> Cá»¦A tabIndex === 4 Báº°NG CODE NĂ€Y

                <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2, overflow: 'hidden' }}>
                    <Table sx={{ minWidth: 650, '& .MuiTableCell-root': { borderBottom: '1px solid', borderColor: 'divider' } }} aria-label="reports table">
                        <TableHead sx={{ bgcolor: 'grey.50' }}>
                            <TableRow>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>MĂ£ phiáº¿u</TableCell>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>TiĂªu Ä‘á» BĂ¡o cĂ¡o</TableCell>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>Pháº¡m vi</TableCell>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>NgÆ°á»i Y/C</TableCell>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary' }}>Tráº¡ng thĂ¡i</TableCell>
                                <TableCell sx={{ fontWeight: 700, color: 'text.secondary', width: '210px' }} align="right">HĂ nh Ä‘á»™ng</TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {filteredReports.map((r) => (
                                <TableRow
                                    key={r.id}
                                    hover
                                    sx={{
                                        cursor: 'pointer',
                                        '&:last-child td, &:last-child th': { border: 0 },
                                        '&:hover': {
                                            boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                                            transform: 'translateY(-1px)',
                                        },
                                        transition: 'all 0.15s ease-in-out',
                                        bgcolor: 'background.paper'
                                    }}
                                    onClick={() => handleOpenReportDetail(r)}
                                >
                                    <TableCell sx={{ fontWeight: 600 }}>
                                        <Chip size="small" label={r.maPhieuHienThi || `#${shortId(r.id)}`} sx={{ fontWeight: 600, bgcolor: 'grey.100' }} />
                                    </TableCell>
                                    <TableCell>
                                        <Stack direction="row" spacing={1.5} alignItems="center">
                                            <Avatar sx={{
                                                width: 32, height: 32,
                                                bgcolor: 'info.lighter',
                                                color: 'info.dark',
                                            }}>
                                                <Sheet size={16} />
                                            </Avatar>
                                            <Box>
                                                <Typography sx={{ fontWeight: 600 }}>{r.title}</Typography>
                                                <Typography variant="caption" color="text.secondary">
                                                    {r.type === 'DEPARTMENT_INVENTORY' ? 'Kiá»ƒm kĂª PhĂ²ng' : (r.type === 'BLOCK_INVENTORY' ? 'Kiá»ƒm kĂª Khá»‘i' : 'Tá»•ng há»£p')}
                                                </Typography>
                                            </Box>
                                        </Stack>
                                    </TableCell>
                                    <TableCell>{r.departmentName}</TableCell>
                                    <TableCell>
                                        <Stack direction="row" spacing={1.5} alignItems="center">
                                            <Avatar sx={{ width: 32, height: 32, bgcolor: 'secondary.lighter', color: 'secondary.main', fontSize: '0.9rem' }}>
                                                {r.requester?.name?.charAt(0)?.toUpperCase() || 'Y'}
                                            </Avatar>
                                            <Box>
                                                <Typography variant="body2" sx={{ fontWeight: 600 }}>{r.requester?.name}</Typography>
                                                <Typography variant="caption" color="text.secondary">{formatTime(r.createdAt)}</Typography>
                                            </Box>
                                        </Stack>
                                    </TableCell>
                                    <TableCell>
                                        <Chip
                                            size="small"
                                            label={reportStatusConfig[r.status]?.label}
                                            color={reportStatusConfig[r.status]?.color || "default"}
                                            icon={reportStatusConfig[r.status]?.icon}
                                            variant="outlined"
                                        />
                                    </TableCell>
                                    <TableCell align="right" onClick={(e) => e.stopPropagation()}>
                                        <Stack direction="row" spacing={0.5} justifyContent="flex-end">
                                            {canProcessReport(r) && (
                                                <>
                                                    <Button
                                                        variant="outlined"
                                                        color="error"
                                                        size="small"
                                                        onClick={() => setRejectReportConfirm(r)}
                                                        disabled={processingReport[r.id]}
                                                    >
                                                        {processingReport[r.id] ? "..." : "Tá»« chá»‘i"}
                                                    </Button>
                                                    <Button
                                                        variant="contained"
                                                        size="small"
                                                        onClick={() => handleSignReport(r)}
                                                        disabled={processingReport[r.id]}
                                                        startIcon={<Check size={16} />}
                                                    >
                                                        {processingReport[r.id] ? "..." : "Duyá»‡t"}
                                                    </Button>
                                                </>
                                            )}
                                            {canDeleteReport(r) && (
                                                <Tooltip title="XĂ³a bĂ¡o cĂ¡o">
                                                    <IconButton
                                                        size="small"
                                                        color="error"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setDeleteReportConfirm(r);
                                                        }}
                                                    >
                                                        <Trash2 size={16} />
                                                    </IconButton>
                                                </Tooltip>
                                            )}
                                            {/* NĂºt xem chi tiáº¿t/in cho cĂ¡c phiáº¿u Ä‘Ă£ xong */}
                                            {!canProcessReport(r) && !canDeleteReport(r) && (
                                                <Button size="small" variant="outlined" onClick={() => handleOpenReportDetail(r)}>
                                                    Chi tiáº¿t
                                                </Button>
                                            )}
                                        </Stack>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            )}
        </Box>
    )
}
            </Paper >
        </motion.div >

    {/* âœ… BÆ¯á»C 8: ThĂªm Dialog xĂ¡c nháº­n In tem */ }
    < Dialog open = { isLabelPrintModalOpen } onClose = {() => setIsLabelPrintModalOpen(false)}>
        <DialogTitle>In Tem cho TĂ i sáº£n</DialogTitle>
        <DialogContent>
            <DialogContentText>
                Báº¡n cĂ³ cháº¯c muá»‘n in tem cho {assetsToPrint.length} tĂ i sáº£n Ä‘Ă£ chá»n khĂ´ng?
            </DialogContentText>
            <Box sx={{ maxHeight: 300, overflow: 'auto', mt: 2 }}>
                <ul>
                    {assetsToPrint.map(asset => (
                        <li key={asset.id}>{asset.name}</li>
                    ))}
                </ul>
            </Box>
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setIsLabelPrintModalOpen(false)}>Há»§y</Button>
            <Button
                onClick={() => {
                    // THĂM DĂ’NG NĂ€Y Äá»‚ KIá»‚M TRA
                    console.log('GiĂ¡ trá»‹ cá»§a labelPrintRef.current:', labelPrintRef.current);
                    handlePrintLabels();
                    setIsLabelPrintModalOpen(false);
                }}
                variant="contained"
            >
                In ngay
            </Button>
        </DialogActions>
    </Dialog >

    {/* Component áº©n Ä‘á»ƒ chá»©a ná»™i dung in */ }
    < div style = {{ display: 'none' }}>
        <AssetLabelPrintTemplate
            ref={labelPrintRef}
            assetsToPrint={assetsToPrint}
            company={companyInfo}
        />
    </div >

    {/* REJECT CONFIRM DIALOG - Improved UI */ }
    < Dialog
open = {!!rejectConfirm}
onClose = {() => setRejectConfirm(null)}
PaperProps = {{ sx: { borderRadius: 3, maxWidth: 420 } }}
    >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1.5, pb: 1 }}>
            <Avatar sx={{ bgcolor: 'error.lighter', color: 'error.main' }}>
                <X />
            </Avatar>
            <Box>
                <Typography variant="h6" fontWeight={700}>Tá»« chá»‘i YĂªu cáº§u</Typography>
                <Typography variant="body2" color="text.secondary">
                    HĂ nh Ä‘á»™ng khĂ´ng thá»ƒ hoĂ n tĂ¡c
                </Typography>
            </Box>
        </DialogTitle>
        <DialogContent>
            <Alert severity="warning" sx={{ mb: 2, borderRadius: 2 }}>
                Báº¡n cĂ³ cháº¯c muá»‘n <strong>tá»« chá»‘i</strong> yĂªu cáº§u nĂ y?
            </Alert>
            <Paper variant="outlined" sx={{ p: 2, borderRadius: 2, bgcolor: 'grey.50' }}>
                <Stack spacing={1}>
                    <Stack direction="row" justifyContent="space-between">
                        <Typography variant="body2" color="text.secondary">TĂ i sáº£n:</Typography>
                        <Typography variant="body2" fontWeight={600}>{rejectConfirm?.assetData?.name}</Typography>
                    </Stack>
                    <Stack direction="row" justifyContent="space-between">
                        <Typography variant="body2" color="text.secondary">Loáº¡i yĂªu cáº§u:</Typography>
                        <Chip
                            size="small"
                            label={rejectConfirm?.type === 'ADD' ? 'ThĂªm má»›i' : 'XĂ³a/Giáº£m'}
                            color={rejectConfirm?.type === 'ADD' ? 'success' : 'error'}
                            variant="outlined"
                        />
                    </Stack>
                </Stack>
            </Paper>
        </DialogContent>
        <DialogActions sx={{ p: 2.5, pt: 1, gap: 1 }}>
            <Button
                onClick={() => setRejectConfirm(null)}
                sx={{ minWidth: 100 }}
            >
                Há»§y
            </Button>
            <Button
                onClick={() => {
                    handleProcessRequest(rejectConfirm, 'reject');
                    setRejectConfirm(null);
                }}
                color="error"
                variant="contained"
                disabled={isProcessingRequest[rejectConfirm?.id]}
                startIcon={<X size={16} />}
                sx={{ minWidth: 140 }}
            >
                {isProcessingRequest[rejectConfirm?.id] ? "Äang xá»­ lĂ½..." : "Tá»« chá»‘i"}
            </Button>
        </DialogActions>
    </Dialog >

    {/* âœ… Cáº£i thiá»‡n: Drawer filter vá»›i responsive design */ }
    < Drawer
anchor = "right"
open = { drawerOpen }
onClose = {() => setDrawerOpen(!1)}
PaperProps = {{
    sx: {
        width: { xs: '85vw', sm: 340 },
        maxWidth: 400
    }
}}
    >
    <Box sx={{ width: '100%', p: { xs: 2, sm: 2.5 } }}>
        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 1 }}>
            <Typography variant="h6" sx={{ fontWeight: 800 }}>Bá»™ lá»c</Typography>
            <IconButton onClick={() => setDrawerOpen(!1)}><X size={18} /></IconButton>
        </Stack>

        <Typography variant="caption" color="text.secondary">Tráº¡ng thĂ¡i</Typography>
        <FormControl fullWidth size="small" sx={{ mt: 0.5, mb: 2 }}>
            <InputLabel>Chá»n tráº¡ng thĂ¡i</InputLabel>
            <Select multiple value={statusMulti} label="Chá»n tráº¡ng thĂ¡i" input={<OutlinedInput label="Chá»n tráº¡ng thĂ¡i" />}
                onChange={(e) => setStatusMulti(typeof e.target.value === "string" ? e.target.value.split(",") : e.target.value)}
                renderValue={(selected) => selected.map((s) => statusConfig[s]?.label || s).join(", ")}
                MenuProps={{ PaperProps: { sx: { maxHeight: 280 } }, }}>
                {ALL_STATUS.map((s) => (
                    <MenuItem key={s} value={s}>
                        <Checkbox checked={statusMulti.indexOf(s) > -1} /><ListItemText primary={statusConfig[s]?.label || s} />
                    </MenuItem>
                ))}
            </Select>
        </FormControl>

        <Typography variant="caption" color="text.secondary">Tá»« phĂ²ng</Typography>
        <Autocomplete multiple size="small" sx={{ mt: 0.5, mb: 2 }} options={departments} getOptionLabel={(option) => option.name}
            value={departments.filter(d => fromDeptIds.includes(d.id))}
            onChange={(event, newValue) => { setFromDeptIds(newValue.map(item => item.id)) }}
            renderInput={(params) => (<TextField{...params} label="Chá»n phĂ²ng chuyá»ƒn" />)} />

        <Typography variant="caption" color="text.secondary">Äáº¿n phĂ²ng</Typography>
        <Autocomplete multiple size="small" sx={{ mt: 0.5, mb: 2 }} options={departments} getOptionLabel={(option) => option.name}
            value={departments.filter(d => toDeptIds.includes(d.id))}
            onChange={(event, newValue) => { setToDeptIds(newValue.map(item => item.id)) }}
            renderInput={(params) => (<TextField{...params} label="Chá»n phĂ²ng nháº­n" />)} />

        <Typography variant="caption" color="text.secondary">NgÆ°á»i táº¡o</Typography>
        <TextField placeholder="Nháº­p tĂªn / UID ngÆ°á»i táº¡o" size="small" fullWidth value={createdBy} onChange={(e) => setCreatedBy(e.target.value)} sx={{ mt: 0.5, mb: 2 }} />

        <Divider sx={{ my: 1.5 }} />
        <Stack direction="row" spacing={1}>
            <Button variant="outlined" fullWidth onClick={() => { setStatusMulti([]); setFromDeptIds([]); setToDeptIds([]); setCreatedBy("") }}>XĂ³a bá»™ lá»c</Button>
            <Button variant="contained" fullWidth onClick={() => setDrawerOpen(!1)}>Ăp dá»¥ng</Button>
        </Stack>
    </Box>
    </Drawer >

    {/* âœ… Cáº£i thiá»‡n: Paste from Excel Dialog vá»›i responsive design */ }
    < Dialog
open = { isPasteModalOpen }
onClose = {() => setIsPasteModalOpen(false)}
fullWidth
maxWidth = "md"
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' }
    }
}}
    >
        <DialogTitle>Nháº­p TĂ i sáº£n hĂ ng loáº¡t tá»« Excel</DialogTitle>
        <DialogContent>
            <DialogContentText sx={{ mb: 2 }}>
                Vui lĂ²ng copy cĂ¡c dĂ²ng tá»« Excel (khĂ´ng bao gá»“m tiĂªu Ä‘á») vĂ  dĂ¡n vĂ o Ă´ bĂªn dÆ°á»›i.
                Äáº£m báº£o cĂ¡c cá»™t theo Ä‘Ăºng thá»© tá»±: <b>TĂªn TĂ i Sáº£n, KĂ­ch ThÆ°á»›c, ÄVT, Sá»‘ LÆ°á»£ng, Ghi ChĂº</b>.
                Táº¥t cáº£ tĂ i sáº£n sáº½ Ä‘Æ°á»£c thĂªm vĂ o phĂ²ng: <b>{departments.find(d => d.id === filterDeptsForAsset[0])?.name || "ChÆ°a chá»n"}</b>
            </DialogContentText>
            <TextField
                autoFocus
                margin="dense"
                label="DĂ¡n dá»¯ liá»‡u tá»« Excel vĂ o Ä‘Ă¢y"
                type="text"
                fullWidth
                multiline
                rows={10}
                value={pastedText}
                onChange={(e) => setPastedText(e.target.value)}
                placeholder="TĂªn tĂ i sáº£n 1	KĂ­ch thÆ°á»›c 1	CĂ¡i	10	Ghi chĂº 1..."
            />
        </DialogContent>
        <DialogActions sx={{ p: "0 24px 16px" }}>
            <Button onClick={() => setIsPasteModalOpen(false)}>Há»§y</Button>
            <Button
                onClick={handlePasteAndSave}
                variant="contained"
                disabled={!pastedText.trim() || filterDeptsForAsset.length !== 1 || creating}
            >
                {creating ? "Äang xá»­ lĂ½..." : "ThĂªm vĂ o danh sĂ¡ch"} {/* <-- Sá»¬A Láº I THĂ€NH DĂ’NG NĂ€Y */}
            </Button>
        </DialogActions>
    </Dialog >


    {/* âœ… Cáº£i thiá»‡n: Dialog Chi tiáº¿t Phiáº¿u vá»›i responsive design */ }
    < Dialog
open = { detailViewOpen }
onClose = { handleCloseDetailView }
fullWidth
maxWidth = "md"
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' }
    }
}}
    >
    { selectedTransfer && (
        <>
            {/* Component áº©n Ä‘á»ƒ in */}
            <div style={{ position: 'absolute', left: -10000, top: 0, height: 0, overflow: 'hidden' }}>
                <TransferPrintTemplate ref={printRef} transfer={selectedTransfer} company={companyInfo} />
            </div>

            <DialogTitle sx={{ py: 1.5, px: 2 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center">
                    <Box>
                        <Typography variant="h6" sx={{ fontWeight: 700 }}>
                            Chi tiáº¿t Phiáº¿u {selectedTransfer.maPhieuHienThi || `#${shortId(selectedTransfer.id)}`}
                        </Typography>
                        <Typography variant="body2" color="text.secondary">
                            Táº¡o bá»Ÿi {selectedTransfer.createdBy?.name} lĂºc {fullTime(selectedTransfer.date)}
                        </Typography>
                    </Box>

                    <Stack direction="row" alignItems="center" spacing={1}>
                        <Button
                            variant="outlined"
                            startIcon={<Printer size={16} />}
                            onClick={handlePrint}
                        >
                            In phiáº¿u
                        </Button>
                        <IconButton onClick={handleCloseDetailView}>
                            <X />
                        </IconButton>
                    </Stack>
                </Stack>
            </DialogTitle>
            <DialogContent dividers sx={{ bgcolor: 'grey.50' }}>
                <Grid container spacing={2}>
                    {/* ===== Cá»˜T TRĂI: QUY TRĂŒNH & HĂ€NH Äá»˜NG ===== */}
                    <Grid size={{ xs: 12, md: 5 }}>
                        <Typography variant="overline" color="text.secondary">Quy trĂ¬nh kĂ½ duyá»‡t</Typography>
                        <Paper variant="outlined" sx={{ p: 2, borderRadius: 2, bgcolor: 'background.paper' }}>
                            <SignatureTimeline signatures={selectedTransfer.signatures} status={selectedTransfer.status} />
                        </Paper>
                        {/* âœ… Báº®T Äáº¦U THĂM MĂƒ QR Táº I ÄĂ‚Y */}
                        <Box sx={{ mt: 2, textAlign: 'center' }}>
                            <QRCodeSVG
                                value={`${window.location.origin}/transfers/${selectedTransfer.id}`}
                                size={128}
                                level="H"
                                imageSettings={{
                                    src: "/logo.png", // ÄÆ°á»ng dáº«n tá»›i logo trong thÆ° má»¥c public
                                    height: 24,
                                    width: 24,
                                    excavate: true,
                                }}
                            />
                            <Typography variant="caption" display="block" color="text.secondary" sx={{ mt: 1 }}>
                                QuĂ©t Ä‘á»ƒ má»Ÿ & duyá»‡t trĂªn Ä‘iá»‡n thoáº¡i
                            </Typography>
                        </Box>

                        <Typography variant="overline" color="text.secondary" sx={{ display: 'block', mt: 2, mb: 1 }}>HĂ nh Ä‘á»™ng</Typography>
                        <Stack spacing={1}>
                            {renderActionButtons(selectedTransfer)}
                            {canDeleteTransfer(selectedTransfer) && (
                                <Button fullWidth variant="text" color="error" startIcon={<Trash2 size={16} />} onClick={() => deleteTransfer(selectedTransfer)}>
                                    XĂ³a phiáº¿u
                                </Button>
                            )}
                        </Stack>
                    </Grid>

                    {/* ===== Cá»˜T PHáº¢I: THĂ”NG TIN CHI TIáº¾T ===== */}
                    <Grid size={{ xs: 12, md: 7 }}>
                        <Typography variant="overline" color="text.secondary">ThĂ´ng tin luĂ¢n chuyá»ƒn</Typography>
                        <Paper variant="outlined" sx={{ p: 2, borderRadius: 2, mb: 2, bgcolor: 'background.paper' }}>
                            <Stack direction="row" alignItems="center" spacing={{ xs: 1, sm: 2 }} justifyContent="space-between">
                                <Box sx={{ flex: 1, textAlign: 'center' }}>
                                    <Typography variant="caption">Tá»« phĂ²ng</Typography>
                                    <Typography sx={{ fontWeight: 600 }}>{selectedTransfer.from}</Typography>
                                </Box>
                                <Avatar sx={{ bgcolor: 'primary.main', color: 'white' }}>
                                    <ArrowRightLeft size={20} />
                                </Avatar>
                                <Box sx={{ flex: 1, textAlign: 'center' }}>
                                    <Typography variant="caption">Äáº¿n phĂ²ng</Typography>
                                    <Typography sx={{ fontWeight: 600 }}>{selectedTransfer.to}</Typography>
                                </Box>
                            </Stack>
                        </Paper>

                        <Typography variant="overline" color="text.secondary">Danh sĂ¡ch tĂ i sáº£n</Typography>
                        <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2, bgcolor: 'background.paper' }}>
                            <Table size="small">
                                <TableHead>
                                    <TableRow>
                                        <TableCell sx={{ fontWeight: 'bold', width: '40%' }}>TĂªn tĂ i sáº£n</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold', width: '20%' }}>KĂ­ch thÆ°á»›c</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold', width: '15%' }} align="right">Sá»‘ lÆ°á»£ng</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold' }}>Ghi chĂº</TableCell>
                                    </TableRow>
                                </TableHead>
                                <TableBody>
                                    {(selectedTransfer.assets || []).map((a) => (
                                        <TableRow key={a.id || a.name} hover>
                                            <TableCell>{a.name}</TableCell>
                                            <TableCell>{a.size || 'â€”'}</TableCell>
                                            <TableCell align="right" sx={{ fontWeight: 500 }}>{a.quantity} {a.unit}</TableCell>
                                            <TableCell>{a.notes || 'â€”'}</TableCell>
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                        </TableContainer>
                    </Grid>
                </Grid>
            </DialogContent>
        </>
    )}
    </Dialog >
    {/* âœ… Cáº£i thiá»‡n: Create Transfer dialog vá»›i responsive design */ }
    < Dialog
open = { isTransferModalOpen }
onClose = {() => { setIsTransferModalOpen(false); setAssetSearchInDialog("") }}
maxWidth = "md"
fullWidth
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' }
    }
}}
    >
        <DialogTitle sx={{ fontWeight: 700 }}>Táº¡o Phiáº¿u LuĂ¢n Chuyá»ƒn TĂ i Sáº£n</DialogTitle>
        <DialogContent>
            <Stepper activeStep={createStep} sx={{ my: 2 }}>
                <Step><StepLabel>ThĂ´ng tin chung</StepLabel></Step>
                <Step><StepLabel>Chá»n tĂ i sáº£n</StepLabel></Step>
                <Step><StepLabel>XĂ¡c nháº­n</StepLabel></Step>
            </Stepper>

            <Box sx={{ mt: 3, minHeight: 250 }}>
                {createStep === 0 && (
                    <Stack spacing={2}>
                        <Autocomplete options={fromDeptOptionsForCreate} getOptionLabel={(option) => option.name || ""}
                            value={departments.find(d => d.id === fromDept) || null}
                            onChange={(event, newValue) => { setFromDept(newValue ? newValue.id : ""); setSelectedAssets([]); setSelectedQuantities({}) }}
                            renderInput={(params) => <TextField{...params} label="Tá»« phĂ²ng" />} />
                        <Autocomplete options={departments.filter((d) => d.id !== fromDept)} getOptionLabel={(option) => option.name || ""}
                            value={departments.find(d => d.id === toDept) || null}
                            onChange={(event, newValue) => { setToDept(newValue ? newValue.id : "") }}
                            renderInput={(params) => <TextField{...params} label="Äáº¿n phĂ²ng" />} />
                    </Stack>
                )}

                {createStep === 1 && (
                    <Stack spacing={2}>
                        <TextField label="đŸ” TĂ¬m tĂ i sáº£n trong phĂ²ng..." variant="outlined" size="small" value={assetSearchInDialog} onChange={(e) => setAssetSearchInDialog(e.target.value)} disabled={!fromDept} />
                        <FormControl fullWidth disabled={!fromDept} >
                            <InputLabel>Chá»n tĂ i sáº£n</InputLabel>
                            <Select multiple value={selectedAssets}
                                onChange={(e) => { const value = e.target.value; setSelectedAssets(typeof value === "string" ? value.split(",") : value) }}
                                input={<OutlinedInput label="Chá»n tĂ i sáº£n" />}
                                renderValue={(selected) => selected.map((id) => assetsWithAvailability.find((a) => a.id === id)?.name || "").join(", ")}
                                MenuProps={{ PaperProps: { sx: { maxHeight: 250 }, }, }}
                            >
                                {assetsWithAvailability
                                    .filter((a) => a.departmentId === fromDept && normVn(a.name).includes(normVn(assetSearchInDialog)))
                                    .map((a) => (
                                        <MenuItem key={a.id} value={a.id} disabled={a.availableQuantity <= 0}>
                                            <Checkbox checked={selectedAssets.indexOf(a.id) > -1} />
                                            <ListItemText primary={a.name} secondary={`Kháº£ dá»¥ng: ${a.availableQuantity} / ${a.quantity} ${a.unit}`} />
                                            {a.availableQuantity <= 0 && (<Chip label="Äang khĂ³a" size="small" color="warning" variant="outlined" sx={{ ml: 1 }} />)}
                                        </MenuItem>
                                    ))}
                                {assetsWithAvailability.filter((a) => a.departmentId === fromDept).length === 0 && (<MenuItem disabled>KhĂ´ng cĂ³ tĂ i sáº£n nĂ o trong phĂ²ng nĂ y.</MenuItem>)}
                                {assetsWithAvailability.filter((a) => a.departmentId === fromDept && normVn(a.name).includes(normVn(assetSearchInDialog))).length === 0
                                    && assetsWithAvailability.filter((a) => a.departmentId === fromDept).length > 0 && (<MenuItem disabled>KhĂ´ng tĂ¬m tháº¥y tĂ i sáº£n phĂ¹ há»£p.</MenuItem>)}
                            </Select>
                        </FormControl>

                        {selectedAssets.length > 0 && (
                            <Box sx={{ border: "1px solid #e0e0e0", borderRadius: 1, p: 2, mt: 1, maxHeight: 200, overflowY: "auto", }}>
                                <Typography variant="subtitle2" sx={{ mb: 1.5 }}>Nháº­p sá»‘ lÆ°á»£ng chuyá»ƒn</Typography>
                                <Stack spacing={1.5}>
                                    {assetsWithAvailability.filter((a) => selectedAssets.includes(a.id)).map((a) => {
                                        const max = Number(a.availableQuantity) || 0;
                                        return (
                                            <TextField key={a.id} label={a.name} size="small" type="number"
                                                helperText={`Tá»“n kho kháº£ dá»¥ng: ${max} ${a.unit}`}
                                                value={selectedQuantities[a.id] || 1}
                                                onChange={(e) => { const n = Math.max(1, Math.min(max, Number(e.target.value || 1))); setSelectedQuantities((q) => ({ ...q, [a.id]: n, })) }}
                                                inputProps={{ min: 1, max: max, }} error={Number(selectedQuantities[a.id] || 1) > max} />
                                        )
                                    })}
                                </Stack>
                            </Box>
                        )}
                    </Stack>
                )}

                {createStep === 2 && (
                    <Box>
                        <Typography>Tá»« phĂ²ng: <b>{departments.find((d) => d.id === fromDept)?.name}</b></Typography>
                        <Typography>Äáº¿n phĂ²ng: <b>{departments.find((d) => d.id === toDept)?.name}</b></Typography>
                        <Typography sx={{ mt: 1 }}>TĂ i sáº£n chuyá»ƒn:</Typography>
                        <ul>
                            {selectedAssets.map(id => {
                                const a = assetsWithAvailability.find(x => x.id === id); if (!a) return null;
                                return <li key={id}>{a.name} (SL: {selectedQuantities[id] || 1} {a.unit})</li>
                            })}
                        </ul>
                    </Box>
                )}
            </Box>
        </DialogContent>
        <DialogActions sx={{ p: "0 24px 16px" }}>
            <Button onClick={() => { setIsTransferModalOpen(false); setAssetSearchInDialog("") }}>Há»§y</Button>
            <Box sx={{ flex: 1 }} />
            {createStep > 0 && (<Button onClick={() => setCreateStep((s) => s - 1)}>Quay láº¡i</Button>)}
            {createStep < 2 && (
                <Button variant="contained" onClick={() => setCreateStep((s) => s + 1)}
                    disabled={(createStep === 0 && (!fromDept || !toDept)) || (createStep === 1 && selectedAssets.length === 0)}>
                    Tiáº¿p theo
                </Button>
            )}
            {createStep === 2 && (
                <Button variant="contained" onClick={handleCreateTransfer} disabled={creating}>
                    {creating ? "Äang táº¡o..." : "XĂ¡c nháº­n & Táº¡o"}
                </Button>
            )}
        </DialogActions>
    </Dialog >

    {/* âœ… Cáº£i thiá»‡n: Asset modal vá»›i responsive design */ }
    < Dialog
open = { isAssetModalOpen }
onClose = {() => setIsAssetModalOpen(false)}
maxWidth = "sm"
fullWidth
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' },
        borderRadius: 3,
            }
}}
    >
        <DialogTitle sx={{
            fontSize: { xs: '1.125rem', sm: '1.25rem' },
            p: { xs: 2, sm: 3 },
            pb: { xs: 1, sm: 1.5 },
            display: 'flex',
            alignItems: 'center',
            gap: 1.5,
        }}>
            <Avatar sx={{
                bgcolor: modalMode === "add" ? 'success.lighter' : 'primary.lighter',
                color: modalMode === "add" ? 'success.main' : 'primary.main'
            }}>
                {modalMode === "add" ? <Add /> : <Edit />}
            </Avatar>
            <Box>
                <Typography variant="h6" fontWeight={700}>
                    {modalMode === "add" ? "ThĂªm TĂ i Sáº£n Má»›i" : "Chá»‰nh Sá»­a TĂ i Sáº£n"}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                    {modalMode === "add" ? "Äiá»n thĂ´ng tin Ä‘á»ƒ gá»­i yĂªu cáº§u" : "Cáº­p nháº­t thĂ´ng tin tĂ i sáº£n"}
                </Typography>
            </Box>
        </DialogTitle>
        <DialogContent sx={{ p: { xs: 2, sm: 3 }, pt: { xs: 1, sm: 1.5 } }}>
            <Stack spacing={3} component="form" id="asset-form" onSubmit={handleSubmit(onSubmitAsset)}>
                <input type="hidden" {...register("id")} />

                {/* Section: ThĂ´ng tin cÆ¡ báº£n */}
                <Box>
                    <Typography variant="overline" color="text.secondary" sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1.5 }}>
                        <Inventory2 sx={{ fontSize: 16 }} /> ThĂ´ng tin cÆ¡ báº£n
                    </Typography>
                    <Stack spacing={2}>
                        <TextField
                            autoFocus
                            label="TĂªn tĂ i sáº£n"
                            fullWidth
                            required
                            placeholder="VD: BĂ n lĂ m viá»‡c, MĂ¡y tĂ­nh Dell..."
                            error={!!errors.name}
                            helperText={errors.name?.message}
                            {...register("name")}
                        />
                        <TextField
                            label="KĂ­ch thÆ°á»›c"
                            placeholder="VD: 80x80cm, 6.5cm x 1.05m..."
                            fullWidth
                            {...register("size")}
                        />
                    </Stack>
                </Box>

                <Divider />

                {/* Section: Sá»‘ lÆ°á»£ng & ÄÆ¡n vá»‹ */}
                <Box>
                    <Typography variant="overline" color="text.secondary" sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1.5 }}>
                        <TagIcon sx={{ fontSize: 16 }} /> Sá»‘ lÆ°á»£ng & ÄÆ¡n vá»‹
                    </Typography>
                    <Grid container spacing={2}>
                        <Grid size={{ xs: 6 }}>
                            <TextField
                                label="Sá»‘ lÆ°á»£ng"
                                type="number"
                                fullWidth
                                required
                                error={!!errors.quantity}
                                helperText={errors.quantity?.message}
                                {...register("quantity")}
                                inputProps={{ min: 1 }}
                            />
                        </Grid>
                        <Grid size={{ xs: 6 }}>
                            <TextField
                                label="ÄÆ¡n vá»‹ tĂ­nh"
                                fullWidth
                                required
                                placeholder="VD: CĂ¡i, Bá»™..."
                                error={!!errors.unit}
                                helperText={errors.unit?.message}
                                {...register("unit")}
                            />
                        </Grid>
                    </Grid>
                </Box>

                <Divider />

                {/* Section: PhĂ²ng ban & Ghi chĂº */}
                <Box>
                    <Typography variant="overline" color="text.secondary" sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1.5 }}>
                        <Business sx={{ fontSize: 16 }} /> Vá»‹ trĂ­ & Ghi chĂº
                    </Typography>
                    <Stack spacing={2}>
                        <Controller
                            name="departmentId"
                            control={control}
                            render={({ field }) => (
                                <Autocomplete
                                    options={departments}
                                    getOptionLabel={(option) => option.name || ""}
                                    value={departments.find(d => d.id === field.value) || null}
                                    onChange={(event, newValue) => { field.onChange(newValue ? newValue.id : ""); }}
                                    renderInput={(params) => (
                                        <TextField {...params} label="PhĂ²ng ban" required error={!!errors.departmentId} helperText={errors.departmentId?.message} />
                                    )}
                                />
                            )}
                        />
                        <TextField
                            label="Ghi chĂº"
                            fullWidth
                            multiline
                            rows={2}
                            placeholder="Ghi chĂº thĂªm (tĂ¹y chá»n)"
                            {...register("notes")}
                        />
                    </Stack>
                </Box>
            </Stack>
        </DialogContent>
        <DialogActions sx={{ p: { xs: 2, sm: 3 }, pt: 0, gap: 1 }}>
            <Button onClick={() => setIsAssetModalOpen(false)} sx={{ minWidth: 100 }}>Há»§y</Button>
            <Button
                type="submit"
                form="asset-form"
                variant="contained"
                startIcon={modalMode === "add" ? <Send size={16} /> : <Check size={16} />}
                sx={{ minWidth: 140 }}
            >
                {modalMode === "add" ? "Gá»­i yĂªu cáº§u" : "LÆ°u thay Ä‘á»•i"}
            </Button>
        </DialogActions>
    </Dialog >

    {/* Delete confirm */ }
    < Dialog open = {!!deleteConfirm} onClose = {() => setDeleteConfirm(null)}>
        <DialogTitle>XĂ¡c nháº­n YĂªu cáº§u XĂ³a</DialogTitle>
        <DialogContent>
            <DialogContentText>
                Báº¡n cĂ³ cháº¯c muá»‘n gá»­i yĂªu cáº§u xĂ³a tĂ i sáº£n â€œ<b>{deleteConfirm?.name}</b>â€ khĂ´ng? TĂ i sáº£n sáº½ chá»‰ bá»‹ xĂ³a sau khi Ä‘Æ°á»£c duyá»‡t.
            </DialogContentText>
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setDeleteConfirm(null)}>Há»§y</Button>
            <Button
                onClick={handleDeleteAsset}
                color="error"
                variant="contained"
                // âœ… THĂM 2 DĂ’NG NĂ€Y VĂ€O
                disabled={isProcessingRequest[deleteConfirm?.id]}
            >
                {isProcessingRequest[deleteConfirm?.id] ? "Äang gá»­i..." : "Gá»­i YĂªu Cáº§u"}
            </Button>
        </DialogActions>
    </Dialog >


    {/* âœ… THĂM DIALOG Má»I CHO VIá»†C GIáº¢M Sá» LÆ¯á»¢NG */ }
    < Dialog open = {!!reduceQuantityTarget} onClose = {() => setReduceQuantityTarget(null)}>
        <DialogTitle>XĂ¡c nháº­n Giáº£m Sá»‘ lÆ°á»£ng TĂ i sáº£n</DialogTitle>
        <DialogContent>
            <DialogContentText component="div" sx={{ mb: 2 }}>
                TĂ i sáº£n "<b>{reduceQuantityTarget?.name}</b>" Ä‘ang cĂ³ <b>{reduceQuantityTarget?.quantity}</b> {reduceQuantityTarget?.unit}.
                <br />
                Vui lĂ²ng nháº­p sá»‘ lÆ°á»£ng báº¡n muá»‘n xĂ³a (giáº£m bá»›t). Má»™t yĂªu cáº§u sáº½ Ä‘Æ°á»£c táº¡o Ä‘á»ƒ chá» duyá»‡t.
            </DialogContentText>
            <TextField
                autoFocus
                margin="dense"
                id="quantity-to-delete"
                label={`Sá»‘ lÆ°á»£ng muá»‘n xĂ³a (tá»‘i Ä‘a ${reduceQuantityTarget?.quantity})`}
                type="number"
                fullWidth
                variant="outlined"
                value={quantityToDelete}
                onChange={(e) => {
                    const val = e.target.value;
                    if (val === "") {
                        setQuantityToDelete("");
                        return;
                    }
                    const num = parseInt(val, 10);
                    const max = reduceQuantityTarget?.quantity || 1;
                    // RĂ ng buá»™c giĂ¡ trá»‹ nháº­p vĂ o
                    if (num <= 0) {
                        setQuantityToDelete(1);
                    } else if (num > max) {
                        setQuantityToDelete(max);
                    } else {
                        setQuantityToDelete(num);
                    }
                }}
                inputProps={{
                    min: 1,
                    max: reduceQuantityTarget?.quantity,
                }}
            />
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setReduceQuantityTarget(null)}>Há»§y</Button>
            <Button
                onClick={handleConfirmReduceQuantity}
                color="error"
                variant="contained"
                // VĂ´ hiá»‡u hĂ³a nĂºt náº¿u khĂ´ng nháº­p sá»‘ lÆ°á»£ng
                disabled={!quantityToDelete || quantityToDelete <= 0}
            >
                Gá»­i YĂªu Cáº§u
            </Button>
        </DialogActions>
    </Dialog >
    {/* DELETE REQUEST CONFIRM DIALOG (NEW) */ }
    < Dialog open = {!!deleteRequestConfirm} onClose = {() => setDeleteRequestConfirm(null)}>
        <DialogTitle>XĂ¡c nháº­n XĂ³a YĂªu cáº§u</DialogTitle>
        <DialogContent>
            <DialogContentText>
                Báº¡n cĂ³ cháº¯c muá»‘n <b>xĂ³a vÄ©nh viá»…n</b> yĂªu cáº§u thay Ä‘á»•i tĂ i sáº£n "<b>{deleteRequestConfirm?.assetData?.name}</b>" khĂ´ng?
                <br />
                HĂ nh Ä‘á»™ng nĂ y sáº½ xĂ³a máº¥t dáº¥u váº¿t vĂ  khĂ´ng thá»ƒ hoĂ n tĂ¡c.
            </DialogContentText>
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setDeleteRequestConfirm(null)}>Há»§y</Button>
            <Button
                onClick={handleDeleteRequest}
                color="error"
                variant="contained"
                disabled={isProcessingRequest[deleteRequestConfirm?.id]}
            >
                {isProcessingRequest[deleteRequestConfirm?.id] ? "Äang xĂ³a..." : "XĂ¡c nháº­n XĂ³a"}
            </Button>
        </DialogActions>
    </Dialog >

    {/* âœ… Cáº£i thiá»‡n: Dialog Chi tiáº¿t YĂªu cáº§u vá»›i responsive design */ }
    < Dialog
open = { isRequestDetailOpen }
onClose = { handleCloseRequestDetail }
fullWidth
maxWidth = "md"
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' }
    }
}}
    >
    { selectedRequest && (
        <>
            {/* Component áº©n Ä‘á»ƒ in */}
            <div style={{ display: 'none' }}>
                <RequestPrintTemplate ref={requestPrintRef} request={selectedRequest} company={companyInfo} />
            </div>

            <DialogTitle>
                <Stack direction="row" justifyContent="space-between" alignItems="center">
                    <Box>
                        <Typography variant="h6" sx={{ fontWeight: 700 }}>
                            Chi tiáº¿t YĂªu cáº§u {selectedRequest.maPhieuHienThi || `#${shortId(selectedRequest.id)}`}
                        </Typography>
                        <Typography variant="body2" color="text.secondary">
                            Táº¡o bá»Ÿi {selectedRequest.requester?.name} lĂºc {fullTime(selectedRequest.createdAt)}
                        </Typography>
                    </Box>
                    <Stack direction="row" alignItems="center" spacing={1}>
                        {/* NĂºt In phiáº¿u */}
                        <Button
                            variant="outlined"
                            startIcon={<Printer size={16} />}
                            onClick={handlePrintRequest}
                        >
                            In phiáº¿u
                        </Button>
                        <IconButton onClick={handleCloseRequestDetail}><X /></IconButton>
                    </Stack>
                </Stack>
            </DialogTitle>
            <DialogContent dividers>
                <Grid container spacing={2}>
                    {/* Cá»™t trĂ¡i: ThĂ´ng tin duyá»‡t */}
                    <Grid size={{ xs: 12, md: 5 }}>
                        <Typography variant="overline" color="text.secondary">Quy trĂ¬nh kĂ½ duyá»‡t</Typography>
                        <RequestSignatureTimeline signatures={selectedRequest.signatures} status={selectedRequest.status} blockName={selectedRequest.managementBlock} />
                        {/* âœ… Báº®T Äáº¦U THĂM MĂƒ QR Táº I ÄĂ‚Y */}
                        <Box sx={{ mt: 2, textAlign: 'center' }}>
                            <QRCodeSVG
                                value={`${window.location.origin}/asset-requests/${selectedRequest.id}`}
                                size={128}
                                level="H"
                                imageSettings={{
                                    src: "/logo.png", // ÄÆ°á»ng dáº«n tá»›i logo trong thÆ° má»¥c public
                                    height: 24,
                                    width: 24,
                                    excavate: true,
                                }}
                            />
                            <Typography variant="caption" display="block" color="text.secondary" sx={{ mt: 1 }}>
                                QuĂ©t Ä‘á»ƒ má»Ÿ & duyá»‡t trĂªn Ä‘iá»‡n thoáº¡i
                            </Typography>
                        </Box>
                        {/* âœ… Káº¾T THĂC THĂM MĂƒ QR */}
                        <Divider sx={{ my: 2 }} />

                        <Typography variant="overline" color="text.secondary">HĂ nh Ä‘á»™ng</Typography>
                        <Stack spacing={1} sx={{ mt: 1 }}>
                            {canProcessRequest(selectedRequest) && (
                                <Button
                                    variant="contained"
                                    onClick={() => handleProcessRequest(selectedRequest, 'approve')}
                                    disabled={isProcessingRequest[selectedRequest.id]}
                                    startIcon={<Check size={16} />}
                                >
                                    {isProcessingRequest[selectedRequest.id] ? "Äang xá»­ lĂ½..." : getApprovalActionLabel(selectedRequest)}
                                </Button>
                            )}
                            {canProcessRequest(selectedRequest) && (
                                <Button
                                    variant="outlined"
                                    color="error"
                                    onClick={() => { setRejectConfirm(selectedRequest); handleCloseRequestDetail(); }}
                                    disabled={isProcessingRequest[selectedRequest.id]}
                                >
                                    {isProcessingRequest[selectedRequest.id] ? "Äang xá»­ lĂ½..." : "Tá»« chá»‘i YĂªu cáº§u"}
                                </Button>
                            )}
                            {!canProcessRequest(selectedRequest) && selectedRequest.status !== 'COMPLETED' && selectedRequest.status !== 'REJECTED' && (
                                <Button variant="outlined" disabled>ÄĂ£ xá»­ lĂ½ hoáº·c chá» lÆ°á»£t</Button>
                            )}
                            {currentUser?.role === 'admin' &&
                                <Button
                                    variant="text"
                                    color="error"
                                    startIcon={<Trash2 size={16} />}
                                    onClick={() => { setDeleteRequestConfirm(selectedRequest); handleCloseRequestDetail(); }}
                                >
                                    XĂ³a vÄ©nh viá»…n (Admin)
                                </Button>
                            }
                        </Stack>
                    </Grid>

                    {/* Cá»™t pháº£i: ThĂ´ng tin tĂ i sáº£n */}
                    <Grid size={{ xs: 12, md: 7 }}>
                        <Typography variant="overline" color="text.secondary">ThĂ´ng tin tĂ i sáº£n Ä‘Æ°á»£c yĂªu cáº§u</Typography>
                        <Paper variant="outlined" sx={{ p: 0, borderRadius: 2, overflow: 'hidden' }}>
                            <Table size="small">
                                <TableBody>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold', width: '35%' }}>Loáº¡i yĂªu cáº§u</TableCell>
                                        <TableCell>
                                            <Chip
                                                label={
                                                    selectedRequest.type === 'ADD' ? 'YĂU Cáº¦U THĂM Má»I' :
                                                        selectedRequest.type === 'DELETE' ? 'YĂU Cáº¦U XĂ“A TOĂ€N Bá»˜' : 'YĂU Cáº¦U GIáº¢M Sá» LÆ¯á»¢NG'
                                                }
                                                size="small"
                                                color={
                                                    selectedRequest.type === 'ADD' ? 'success' :
                                                        selectedRequest.type === 'DELETE' ? 'error' : 'warning'
                                                }
                                            />
                                        </TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>TĂªn tĂ i sáº£n</TableCell>
                                        <TableCell>{selectedRequest.assetData?.name}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>KĂ­ch thÆ°á»›c</TableCell>
                                        <TableCell>{selectedRequest.assetData?.size || 'â€”'}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>PhĂ²ng ban</TableCell>
                                        <TableCell>{selectedRequest.departmentName}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>Khá»‘i</TableCell>
                                        <TableCell>{selectedRequest.managementBlock || 'â€”'}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>
                                            {selectedRequest.type === 'REDUCE_QUANTITY' ? 'Sá»‘ lÆ°á»£ng cáº§n giáº£m' :
                                                selectedRequest.type === 'DELETE' ? 'Sá»‘ lÆ°á»£ng hiá»‡n cĂ³' : 'Sá»‘ lÆ°á»£ng'}
                                        </TableCell>
                                        <TableCell>{selectedRequest.assetData?.quantity} {selectedRequest.assetData?.unit}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>MĂ´ táº£</TableCell>
                                        <TableCell sx={{ whiteSpace: 'pre-wrap' }}>{selectedRequest.assetData?.description || 'â€”'}</TableCell>
                                    </TableRow>
                                    <TableRow>
                                        <TableCell variant="head" sx={{ fontWeight: 'bold' }}>Ghi chĂº</TableCell>
                                        <TableCell sx={{ whiteSpace: 'pre-wrap' }}>{selectedRequest.assetData?.notes || 'â€”'}</TableCell>
                                    </TableRow>
                                </TableBody>
                            </Table>
                        </Paper>
                    </Grid>
                </Grid>
            </DialogContent>
            <DialogActions>
                <Button onClick={handleCloseRequestDetail}>ÄĂ³ng</Button>
            </DialogActions>
        </>
    )}
    </Dialog >

    {/* âœ… Cáº£i thiá»‡n: Dialog Táº¡o BĂ¡o cĂ¡o vá»›i responsive design */ }
    < Dialog
open = { isPrintModalOpen }
onClose = {() => setIsPrintModalOpen(false)}
fullWidth
maxWidth = "sm"
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' }
    }
}}
    >
        <DialogTitle sx={{ fontWeight: 700 }}>Táº¡o BĂ¡o cĂ¡o Kiá»ƒm kĂª</DialogTitle>
        <DialogContent>
            <DialogContentText sx={{ mb: 3 }}>
                Chá»n loáº¡i bĂ¡o cĂ¡o báº¡n muá»‘n táº¡o. BĂ¡o cĂ¡o sáº½ Ä‘Æ°á»£c táº¡o vĂ  Ä‘Æ°a vĂ o luá»“ng kĂ½ duyá»‡t.
            </DialogContentText>

            {/* Bá» Cá»¤C 2 Lá»°A CHá»ŒN */}
            <Grid container spacing={2}>
                {/* Lá»±a chá»n 1: Theo Khá»‘i */}
                <Grid size={{ xs: 12, sm: 6 }}>
                    <Card
                        variant="outlined"
                        sx={{
                            height: '100%',
                            borderColor: printType === 'block' ? 'primary.main' : 'divider',
                            boxShadow: printType === 'block' ? '0 2px 12px rgba(0,0,0,0.08)' : 'none'
                        }}
                    >
                        <CardActionArea onClick={() => setPrintType('block')} sx={{ p: 2, height: '100%' }}>
                            <Stack spacing={1} alignItems="center" textAlign="center">
                                <Avatar sx={{ bgcolor: printType === 'block' ? 'primary.main' : 'grey.300', color: 'white' }}>
                                    <GroupWork />
                                </Avatar>
                                <Box>
                                    <Typography sx={{ fontWeight: 600 }}>Theo Khá»‘i</Typography>
                                    <Typography variant="caption" color="text.secondary">
                                        Gá»™p nhiá»u phĂ²ng trong má»™t khá»‘i.
                                    </Typography>
                                </Box>
                            </Stack>
                        </CardActionArea>
                    </Card>
                </Grid>

                {/* Lá»±a chá»n 2: ToĂ n cĂ´ng ty */}
                <Grid size={{ xs: 12, sm: 6 }}>
                    <Card
                        variant="outlined"
                        sx={{
                            height: '100%',
                            borderColor: printType === 'summary' ? 'primary.main' : 'divider',
                            boxShadow: printType === 'summary' ? '0 2px 12px rgba(0,0,0,0.08)' : 'none'
                        }}
                    >
                        <CardActionArea onClick={() => setPrintType('summary')} sx={{ p: 2, height: '100%' }}>
                            <Stack spacing={1} alignItems="center" textAlign="center">
                                <Avatar sx={{ bgcolor: printType === 'summary' ? 'primary.main' : 'grey.300', color: 'white' }}>
                                    <Warehouse size={20} />
                                </Avatar>
                                <Box>
                                    <Typography sx={{ fontWeight: 600 }}>ToĂ n cĂ´ng ty</Typography>
                                    <Typography variant="caption" color="text.secondary">
                                        Tá»•ng há»£p táº¥t cáº£ tĂ i sáº£n.
                                    </Typography>
                                </Box>
                            </Stack>
                        </CardActionArea>
                    </Card>
                </Grid>
            </Grid>

            {/* Autocomplete Ä‘á»ƒ chá»n KHá»I (chá»‰ hiá»‡n khi chá»n 'Theo Khá»‘i') */}
            <Collapse in={printType === 'block'} timeout={300}>
                <Autocomplete
                    options={managementBlocks}
                    getOptionLabel={(option) => option}
                    value={selectedBlockForPrint || null}
                    onChange={(event, newValue) => {
                        setSelectedBlockForPrint(newValue || '');
                    }}
                    renderInput={(params) => (
                        <TextField {...params} label="Chá»n Khá»‘i quáº£n lĂ½" margin="normal" fullWidth />
                    )}
                    sx={{ mt: 1 }}
                />
            </Collapse>

        </DialogContent>
        <DialogActions sx={{ p: '16px 24px' }}>
            <Button onClick={() => setIsPrintModalOpen(false)}>Há»§y</Button>
            <Button
                onClick={handleCreatePrintRequest}
                variant="contained"
                disabled={
                    isCreatingReport ||
                    (printType === 'block' && !selectedBlockForPrint) ||
                    (printType === 'summary' && assets.length === 0) ||
                    !printType
                }
            >
                {isCreatingReport ? "Äang xá»­ lĂ½..." : "Táº¡o YĂªu cáº§u"}
            </Button>
        </DialogActions>
    </Dialog >
    {/* âœ… Cáº£i thiá»‡n: Dialog Chi tiáº¿t BĂ¡o cĂ¡o vá»›i responsive design */ }
    < Dialog
open = { isReportDetailOpen }
onClose = { handleCloseReportDetail }
fullWidth
maxWidth = "md"
PaperProps = {{
    sx: {
        m: { xs: 1, sm: 2 },
        width: { xs: 'calc(100% - 16px)', sm: 'auto' },
        maxHeight: { xs: 'calc(100% - 32px)', sm: '90vh' }
    }
}}
    >
    { selectedReport && (
        <>
            {/* Component áº©n Ä‘á»ƒ in - Sáº¼ CHá»ŒN TEMPLATE PHĂ™ Há»¢P */}
            <div style={{ position: 'absolute', left: -10000, top: 0, height: 0, overflow: 'hidden' }}>
                {(selectedReport.type === 'DEPARTMENT_INVENTORY' || selectedReport.type === 'BLOCK_INVENTORY')
                    ? <AssetListPrintTemplate ref={reportPrintRef} report={selectedReport} company={companyInfo} departments={departments} />
                    : <AssetSummaryPrintTemplate ref={reportPrintRef} report={selectedReport} company={companyInfo} departments={departments} />
                }
            </div>


            <DialogTitle>
                <Stack direction="row" justifyContent="space-between" alignItems="center">
                    <Box>
                        <Typography variant="h6" sx={{ fontWeight: 700 }}>
                            Chi tiáº¿t BĂ¡o cĂ¡o {selectedReport.maPhieuHienThi || `#${shortId(selectedReport.id)}`}
                        </Typography>
                        <Typography variant="body2" color="text.secondary">
                            {selectedReport.title}
                        </Typography>
                    </Box>
                    <IconButton onClick={handleCloseReportDetail}><X /></IconButton>
                </Stack>
            </DialogTitle>
            <DialogContent dividers>
                <Grid container spacing={2}>
                    <Grid size={{ xs: 12, md: 5 }}>
                        <Typography variant="overline" color="text.secondary">Quy trĂ¬nh kĂ½ duyá»‡t</Typography>
                        <ReportSignatureTimeline signatures={selectedReport.signatures} status={selectedReport.status} type={selectedReport.type} />
                        {/* âœ… Báº®T Äáº¦U THĂM MĂƒ QR Táº I ÄĂ‚Y */}
                        <Box sx={{ mt: 2, textAlign: 'center' }}>
                            <QRCodeSVG
                                value={`${window.location.origin}/inventory-reports/${selectedReport.id}`}
                                size={128}
                                level="H"
                                imageSettings={{
                                    src: "/logo.png", // ÄÆ°á»ng dáº«n tá»›i logo trong thÆ° má»¥c public
                                    height: 24,
                                    width: 24,
                                    excavate: true,
                                }}
                            />
                            <Typography variant="caption" display="block" color="text.secondary" sx={{ mt: 1 }}>
                                QuĂ©t Ä‘á»ƒ má»Ÿ bĂ¡o cĂ¡o trĂªn Ä‘iá»‡n thoáº¡i
                            </Typography>
                        </Box>
                        <Divider sx={{ my: 2 }} />

                        <Stack spacing={1} sx={{ mt: 1 }}>
                            {canProcessReport(selectedReport) && (
                                <Button
                                    fullWidth
                                    variant="contained"
                                    startIcon={<Check size={16} />}
                                    onClick={() => handleSignReport(selectedReport)}
                                    disabled={processingReport[selectedReport.id]}
                                >
                                    {processingReport[selectedReport.id] ? "Äang xá»­ lĂ½..." : "XĂ¡c nháº­n & Duyá»‡t"}
                                </Button>
                            )}
                            {canProcessReport(selectedReport) && (
                                <Button
                                    fullWidth
                                    variant="outlined"
                                    color="error"
                                    onClick={() => { setRejectReportConfirm(selectedReport); handleCloseReportDetail(); }}
                                    disabled={processingReport[selectedReport.id]}
                                >
                                    {processingReport[selectedReport.id] ? "Äang xá»­ lĂ½..." : "Tá»« chá»‘i BĂ¡o cĂ¡o"}
                                </Button>
                            )}

                            {/* === THAY Äá»”I Báº®T Äáº¦U Tá»ª ÄĂ‚Y === */}
                            {/* NĂºt In (luĂ´n hiá»ƒn thá»‹, thay Ä‘á»•i theo tráº¡ng thĂ¡i) */}
                            <Button
                                fullWidth
                                // Náº¿u Ä‘Ă£ hoĂ n thĂ nh, nĂºt In lĂ  nĂºt chĂ­nh. Náº¿u chÆ°a, lĂ  nĂºt phá»¥.
                                variant={selectedReport.status === 'COMPLETED' ? "contained" : "outlined"}
                                color="secondary" // DĂ¹ng mĂ u khĂ¡c Ä‘á»ƒ phĂ¢n biá»‡t vá»›i nĂºt Duyá»‡t
                                startIcon={<Printer size={16} />}
                                onClick={handlePrintReport}
                                sx={{ mt: 1 }}
                            >
                                {selectedReport.status === 'COMPLETED' ? "In BiĂªn báº£n ChĂ­nh thá»©c" : "In Báº£n nhĂ¡p"}
                            </Button>
                            {/* === THAY Äá»”I Káº¾T THĂC Táº I ÄĂ‚Y === */}
                        </Stack>
                    </Grid>
                    <Grid size={{ xs: 12, md: 7 }}>
                        <Typography variant="overline" color="text.secondary">Danh sĂ¡ch tĂ i sáº£n kiá»ƒm kĂª</Typography>
                        <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 2, mt: 1, maxHeight: 400 }}>
                            <Table size="small" stickyHeader>
                                <TableHead>
                                    <TableRow>
                                        <TableCell sx={{ fontWeight: 'bold', width: '35%' }}>TĂªn tĂ i sáº£n</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold', width: '15%' }}>KĂ­ch thÆ°á»›c</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold', width: '10%' }} align="right">Sá»‘ lÆ°á»£ng</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold', width: '10%' }}>ÄVT</TableCell>
                                        <TableCell sx={{ fontWeight: 'bold' }}>Ghi chĂº</TableCell>
                                    </TableRow>
                                </TableHead>
                                <TableBody>
                                    {groupedReportAssets.length > 0 ? groupedReportAssets.map((block) => (
                                        <React.Fragment key={block.blockName}>
                                            <TableRow>
                                                <TableCell
                                                    colSpan={5}
                                                    sx={{
                                                        fontWeight: 800,
                                                        textTransform: 'uppercase',
                                                        bgcolor: 'grey.200',
                                                        color: 'grey.800',
                                                        borderBottom: '2px solid',
                                                        borderColor: 'grey.400'
                                                    }}
                                                >
                                                    Khá»‘i: {block.blockName}
                                                </TableCell>
                                            </TableRow>
                                            {block.departments.map(dept => (
                                                <React.Fragment key={dept.deptName}>
                                                    <TableRow>
                                                        <TableCell colSpan={5} sx={{ fontWeight: 600, bgcolor: 'grey.50', pl: 4 }}>
                                                            PhĂ²ng: {dept.deptName}
                                                        </TableCell>
                                                    </TableRow>
                                                    {dept.assets.map((a, index) => (
                                                        <TableRow key={a.id || index}>
                                                            <TableCell sx={{ pl: 6 }}>{a.name}</TableCell>
                                                            <TableCell>{a.size || 'â€”'}</TableCell>
                                                            <TableCell align="right">{a.quantity}</TableCell>
                                                            <TableCell>{a.unit}</TableCell>
                                                            <TableCell>{a.notes || 'â€”'}</TableCell>
                                                        </TableRow>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </React.Fragment>
                                    )) : (
                                        <TableRow>
                                            <TableCell colSpan={5} align="center" sx={{ py: 4 }}>
                                                <Typography color="text.secondary">KhĂ´ng cĂ³ tĂ i sáº£n nĂ o trong bĂ¡o cĂ¡o nĂ y.</Typography>
                                            </TableCell>
                                        </TableRow>
                                    )}
                                </TableBody>
                            </Table>
                        </TableContainer>
                    </Grid>
                </Grid>
            </DialogContent>
        </>
    )}
    </Dialog >
    {/* DELETE REPORT CONFIRM DIALOG - Improved UI */ }
    < Dialog
open = {!!deleteReportConfirm}
onClose = {() => setDeleteReportConfirm(null)}
PaperProps = {{ sx: { borderRadius: 3, maxWidth: 420 } }}
    >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1.5, pb: 1 }}>
            <Avatar sx={{ bgcolor: 'error.lighter', color: 'error.main' }}>
                <Trash2 />
            </Avatar>
            <Box>
                <Typography variant="h6" fontWeight={700}>XĂ³a BĂ¡o cĂ¡o</Typography>
                <Typography variant="body2" color="text.secondary">
                    HĂ nh Ä‘á»™ng khĂ´ng thá»ƒ hoĂ n tĂ¡c
                </Typography>
            </Box>
        </DialogTitle>
        <DialogContent>
            <Alert severity="error" sx={{ mb: 2, borderRadius: 2 }}>
                Báº¡n cĂ³ cháº¯c muá»‘n <strong>xĂ³a vÄ©nh viá»…n</strong> bĂ¡o cĂ¡o nĂ y?
            </Alert>
            <Paper variant="outlined" sx={{ p: 2, borderRadius: 2, bgcolor: 'grey.50' }}>
                <Stack direction="row" alignItems="center" spacing={1.5}>
                    <Avatar sx={{ bgcolor: 'info.lighter', width: 36, height: 36 }}>
                        <Sheet sx={{ fontSize: 18, color: 'info.main' }} />
                    </Avatar>
                    <Typography variant="body2" fontWeight={600}>
                        {deleteReportConfirm?.title}
                    </Typography>
                </Stack>
            </Paper>
        </DialogContent>
        <DialogActions sx={{ p: 2.5, pt: 1, gap: 1 }}>
            <Button onClick={() => setDeleteReportConfirm(null)} sx={{ minWidth: 100 }}>
                Há»§y
            </Button>
            <Button
                onClick={handleDeleteReport}
                color="error"
                variant="contained"
                startIcon={<Trash2 size={16} />}
                sx={{ minWidth: 120 }}
            >
                XĂ³a
            </Button>
        </DialogActions>
    </Dialog >
    {/* REJECT REPORT CONFIRM DIALOG - Improved UI */ }
    < Dialog
open = {!!rejectReportConfirm}
onClose = {() => setRejectReportConfirm(null)}
PaperProps = {{ sx: { borderRadius: 3, maxWidth: 420 } }}
    >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1.5, pb: 1 }}>
            <Avatar sx={{ bgcolor: 'warning.lighter', color: 'warning.main' }}>
                <X />
            </Avatar>
            <Box>
                <Typography variant="h6" fontWeight={700}>Tá»« chá»‘i BĂ¡o cĂ¡o</Typography>
                <Typography variant="body2" color="text.secondary">
                    HĂ nh Ä‘á»™ng khĂ´ng thá»ƒ hoĂ n tĂ¡c
                </Typography>
            </Box>
        </DialogTitle>
        <DialogContent>
            <Alert severity="warning" sx={{ mb: 2, borderRadius: 2 }}>
                Báº¡n cĂ³ cháº¯c muá»‘n <strong>tá»« chá»‘i</strong> bĂ¡o cĂ¡o nĂ y?
            </Alert>
            <Paper variant="outlined" sx={{ p: 2, borderRadius: 2, bgcolor: 'grey.50' }}>
                <Stack direction="row" alignItems="center" spacing={1.5}>
                    <Avatar sx={{ bgcolor: 'info.lighter', width: 36, height: 36 }}>
                        <Sheet sx={{ fontSize: 18, color: 'info.main' }} />
                    </Avatar>
                    <Typography variant="body2" fontWeight={600}>
                        {rejectReportConfirm?.title}
                    </Typography>
                </Stack>
            </Paper>
        </DialogContent>
        <DialogActions sx={{ p: 2.5, pt: 1, gap: 1 }}>
            <Button onClick={() => setRejectReportConfirm(null)} sx={{ minWidth: 100 }}>
                Há»§y
            </Button>
            <Button
                onClick={handleRejectReport}
                color="error"
                variant="contained"
                disabled={processingReport[rejectReportConfirm?.id]}
                startIcon={<X size={16} />}
                sx={{ minWidth: 140 }}
            >
                {processingReport[rejectReportConfirm?.id] ? "Äang xá»­ lĂ½..." : "Tá»« chá»‘i"}
            </Button>
        </DialogActions>
    </Dialog >
    {/* UPDATE DATE DIALOG - Improved UI */ }
    < Dialog
open = { isUpdateDateModalOpen }
onClose = {() => setIsUpdateDateModalOpen(false)}
PaperProps = {{ sx: { borderRadius: 3, maxWidth: 420 } }}
    >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1.5, pb: 1 }}>
            <Avatar sx={{ bgcolor: 'primary.lighter', color: 'primary.main' }}>
                <Calendar />
            </Avatar>
            <Box>
                <Typography variant="h6" fontWeight={700}>Cáº­p nháº­t NgĂ y kiá»ƒm kĂª</Typography>
                <Typography variant="body2" color="text.secondary">
                    Cho {selectedAssetIdsForPrint.length} tĂ i sáº£n Ä‘Ă£ chá»n
                </Typography>
            </Box>
        </DialogTitle>
        <DialogContent sx={{ minWidth: 350 }}>
            <Alert severity="info" icon={<Calendar sx={{ fontSize: 20 }} />} sx={{ mb: 2, borderRadius: 2 }}>
                Chá»n ngĂ y má»›i Ä‘á»ƒ Ä‘Ă¡nh dáº¥u kiá»ƒm kĂª
            </Alert>

            {/* Bá»c DatePicker báº±ng LocalizationProvider */}
            <LocalizationProvider dateAdapter={AdapterDateFns} adapterLocale={vi}>
                <DatePicker
                    label="NgĂ y kiá»ƒm kĂª má»›i"
                    value={newCheckDate}
                    onChange={(newValue) => setNewCheckDate(newValue)}
                    enableAccessibleFieldDOMStructure={false}
                    slots={{
                        textField: (params) => <TextField {...params} fullWidth autoFocus />
                    }}
                />
            </LocalizationProvider>
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setIsUpdateDateModalOpen(false)} disabled={isUpdatingDates}>
                Há»§y
            </Button>
            <Button
                onClick={handleConfirmUpdateDates}
                variant="contained"
                disabled={!newCheckDate || isUpdatingDates}
            >
                {isUpdatingDates ? "Äang cáº­p nháº­t..." : "XĂ¡c nháº­n"}
            </Button>
        </DialogActions>
    </Dialog >
    {/* âœ… THĂM DIALOG Má»I NĂ€Y VĂ€O */ }
    < Dialog open = {!!confirmation} onClose = {() => setConfirmation(null)}>
        <DialogTitle sx={{ fontWeight: 700 }}>XĂ¡c nháº­n ThĂªm TĂ i sáº£n</DialogTitle>
        <DialogContent>
            <DialogContentText>
                TĂ i sáº£n "<b>{confirmation?.newAsset.name}</b>"
                (ÄVT: {confirmation?.newAsset.unit}, KĂ­ch thÆ°á»›c: {confirmation?.newAsset.size || 'N/A'})
                Ä‘Ă£ tá»“n táº¡i trong phĂ²ng ban nĂ y vá»›i sá»‘ lÆ°á»£ng hiá»‡n táº¡i lĂ  <b>{confirmation?.existingDoc.quantity}</b>.
                <br /><br />
                Báº¡n cĂ³ muá»‘n gá»­i yĂªu cáº§u <b>cá»™ng thĂªm {confirmation?.newAsset.quantity}</b> vĂ o sá»‘ lÆ°á»£ng hiá»‡n cĂ³ khĂ´ng?
            </DialogContentText>
        </DialogContent>
        <DialogActions>
            <Button onClick={() => setConfirmation(null)}>Há»§y</Button>
            <Button
                onClick={async () => {
                    try {
                        await callCreateAssetRequest(
                            "INCREASE_QUANTITY",
                            confirmation.newAsset,
                            confirmation.existingDocId,
                            confirmation.newAsset.quantity
                        );
                    } catch (e) {
                        setToast({ open: true, msg: "Gá»­i yĂªu cáº§u tháº¥t báº¡i: " + e.message, severity: "error" });
                    }
                    setConfirmation(null); // ÄĂ³ng dialog
                }}
                variant="contained"
            >
                Gá»­i YĂªu Cáº§u Cáº­p Nháº­t
            </Button>
        </DialogActions>
    </Dialog >

    {/* Snackbars */ }
    < Snackbar open = { toast.open } autoHideDuration = { 4000} onClose = {() => setToast({ ...toast, open: false })}
anchorOrigin = {{ vertical: "bottom", horizontal: "center" }}>
    <Alert onClose={() => setToast({ ...toast, open: false })} severity={toast.severity} variant="filled" sx={{ width: "100%" }}>{toast.msg}</Alert>
            </Snackbar >

    <Snackbar open={undo.open} onClose={() => setUndo({ open: false, transfer: null })} message="Phiáº¿u Ä‘Ă£ xĂ³a"
        anchorOrigin={{ vertical: "bottom", horizontal: "left" }}
        action={<>
            <Button size="small" onClick={handleUndoDelete}>HOĂ€N TĂC</Button>
            <IconButton size="small" color="inherit" onClick={() => setUndo({ open: false, transfer: null })}><X size={14} /></IconButton>
        </>} autoHideDuration={5000} />
        </Box >
    )
}
